<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego de Coches - Circuito SPA</title>
<style>
  html,body{margin:0;overflow:hidden;background:#000}
  #renderCanvas{width:100%;height:100%}
  #joystick-container{position:absolute;bottom:30px;left:30px;width:150px;height:150px;z-index:10}
  .button{position:absolute;bottom:30px;width:60px;height:60px;background:rgba(255,255,255,0.2);border-radius:50%;pointer-events:auto;}
  #btnAccelerate{right:100px} #btnBrake{right:180px}
  #speedBarContainer{position:absolute;top:10px;left:10px;width:200px;height:20px;background:#444;border:1px solid #fff}
  #speedBar{height:100%;width:0%;background:#0f0;transition:width .3s}
  #lapCounter{position:absolute;top:40px;left:10px;color:#fff;font-size:18px;font-weight:bold}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<div id="joystick-container"></div>
<div id="speedBarContainer"><div id="speedBar"></div></div>
<div id="lapCounter">Vuelta: 1/3</div>
<div class="button" id="btnAccelerate"></div>
<div class="button" id="btnBrake"></div>

<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>

<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas,true);
const scene = new BABYLON.Scene(engine);
scene.preventDefaultOnDoubleClick = false;
scene.collisionsEnabled = true;
scene.gravity = new BABYLON.Vector3(0,-9.81,0);

// Cámara para juego de coches
const camera = new BABYLON.FollowCamera("followCam", new BABYLON.Vector3(0, 5, -10), scene);
camera.lockedTarget = null;
camera.radius = 8;
camera.heightOffset = 3;
camera.rotationOffset = 0;
camera.cameraAcceleration = 0.1;
camera.maxCameraSpeed = 20;
camera.attachControl(canvas,true);

// Luz ambiental
const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);
light.intensity = 0.8;

// Variables del juego
let velocidad = 0;
let acelerando = false;
let frenando = false;
const velocidadMaxima = 0.3;
const aceleracion = 0.02;
const friccion = 0.015;
const frenada = 0.04;

const speedBar = document.getElementById("speedBar");
const lapCounter = document.getElementById("lapCounter");

function updateSpeedBar(){
  const porcentaje = Math.min((velocidad / velocidadMaxima) * 100, 100);
  speedBar.style.width = porcentaje + "%";
  
  if (porcentaje < 30) {
    speedBar.style.background = "#0f0";
  } else if (porcentaje < 70) {
    speedBar.style.background = "#ff0";
  } else {
    speedBar.style.background = "#f00";
  }
}

// Controles
let joyX=0, joyY=0;
const joystick = nipplejs.create({
  zone: document.getElementById("joystick-container"),
  mode: "static", position:{left:"75px",bottom:"75px"},
  size:120, color:"white"
});
joystick.on("move", (_,d)=>{ joyX=d.vector.x; joyY=d.vector.y; });
joystick.on("end", ()=>{ joyX=0; joyY=0; });

// Variables del juego
let carMesh = null;
let circuitMesh = null;
let currentLap = 1;
let totalLaps = 3;

// Primero cargar el circuito SPA
BABYLON.SceneLoader.Append("", "spa.glb", scene, (scene) => {
  console.log("Circuito SPA cargado");
  
  // Buscar y configurar el circuito
  scene.meshes.forEach(mesh => {
    if (mesh.name && (mesh.name.toLowerCase().includes("circuit") || 
                     mesh.name.toLowerCase().includes("track") || 
                     mesh.name.toLowerCase().includes("spa") || 
                     mesh.name.toLowerCase().includes("road"))) {
      circuitMesh = mesh;
      console.log("Circuito encontrado:", mesh.name);
      
      // Configurar colisiones del circuito
      circuitMesh.checkCollisions = true;
      
      // Crear impostor de colisión para el circuito
      if (circuitMesh.getChildren) {
        circuitMesh.getChildren().forEach(child => {
          child.checkCollisions = true;
        });
      }
    }
  });
  
  // Si no encontramos un mesh específico, usar todos los meshes del circuito
  if (!circuitMesh && scene.meshes.length > 1) {
    scene.meshes.forEach(mesh => {
      mesh.checkCollisions = true;
    });
    circuitMesh = scene.meshes[0];
  }
  
  // Ahora cargar el Lambo
  loadLambo();
});

function loadLambo() {
  console.log("Cargando Lamborghini...");
  
  BABYLON.SceneLoader.ImportMesh("", "", "lambo.glb", scene, (meshes) => {
    console.log("Lamborghini cargado");
    
    // Encontrar el mesh principal del coche
    carMesh = meshes[0];
    
    // Configurar el coche
    carMesh.name = "lambo";
    carMesh.position = new BABYLON.Vector3(0, 2, 0);
    carMesh.scaling = new BABYLON.Vector3(1, 1, 1);
    
    // Configurar colisiones del coche
    carMesh.checkCollisions = true;
    
    // Crear ellipsoid de colisión para el coche
    const boundingInfo = carMesh.getBoundingInfo();
    const size = boundingInfo.boundingBox.maximum.subtract(boundingInfo.boundingBox.minimum);
    carMesh.ellipsoid = new BABYLON.Vector3(size.x/2, size.y/2, size.z/2);
    carMesh.ellipsoidOffset = new BABYLON.Vector3(0, size.y/2, 0);
    
    // Configurar la cámara para seguir el coche
    camera.lockedTarget = carMesh;
    
    // Posicionar el coche en la pista
    positionCarOnTrack();
    
    console.log("Lambo configurado con colisiones");
    
  }, null, (scene, message) => {
    console.error("Error cargando lambo.glb:", message);
    alert("Error: No se pudo cargar lambo.glb");
  });
}

function positionCarOnTrack() {
  if (!carMesh || !circuitMesh) return;
  
  // Buscar una posición plana en el circuito
  const ray = new BABYLON.Ray(
    new BABYLON.Vector3(0, 100, 0), // Desde arriba
    new BABYLON.Vector3(0, -1, 0),  // Hacia abajo
    200                             // Longitud del rayo
  );
  
  const hit = scene.pickWithRay(ray);
  if (hit.hit) {
    carMesh.position.x = hit.pickedPoint.x;
    carMesh.position.y = hit.pickedPoint.y + 1; // Un poco arriba de la superficie
    carMesh.position.z = hit.pickedPoint.z;
    console.log("Coche posicionado en la pista:", carMesh.position);
  }
}

// Controles de aceleración y freno
document.getElementById("btnAccelerate").onclick = function() {
  acelerando = true;
};
document.getElementById("btnAccelerate").addEventListener("touchstart", function() {
  acelerando = true;
});
document.getElementById("btnAccelerate").addEventListener("touchend", function() {
  acelerando = false;
});

document.getElementById("btnBrake").onclick = function() {
  frenando = true;
};
document.getElementById("btnBrake").addEventListener("touchstart", function() {
  frenando = true;
});
document.getElementById("btnBrake").addEventListener("touchend", function() {
  frenando = false;
});

// Bucle principal del juego
engine.runRenderLoop(()=>{
  if (!carMesh) return;
  
  // Física del coche
  if (acelerando) {
    velocidad = Math.min(velocidad + aceleracion, velocidadMaxima);
  } else if (frenando) {
    velocidad = Math.max(velocidad - frenada, -velocidadMaxima * 0.5);
  } else {
    // Fricción natural
    if (velocidad > 0) {
      velocidad = Math.max(velocidad - friccion, 0);
    } else if (velocidad < 0) {
      velocidad = Math.min(velocidad + friccion, 0);
    }
  }
  
  // Movimiento del coche
  if (Math.abs(velocidad) > 0.01) {
    // Dirección basada en el joystick
    const rotationSpeed = 0.03 * (Math.abs(velocidad) / velocidadMaxima);
    carMesh.rotation.y += joyX * rotationSpeed;
    
    // Movimiento hacia adelante/atrás
    const direction = new BABYLON.Vector3(
      Math.sin(carMesh.rotation.y),
      0,
      Math.cos(carMesh.rotation.y)
    );
    
    // Mover el coche con colisiones
    const movement = direction.scale(velocidad);
    carMesh.moveWithCollisions(movement);
    
    // Mantener el coche sobre la pista
    keepCarOnTrack();
  }
  
  // Actualizar UI
  updateSpeedBar();
  
  scene.render();
});

function keepCarOnTrack() {
  if (!carMesh || !circuitMesh) return;
  
  // Lanzar rayos hacia abajo para mantener el coche sobre la pista
  const rayOrigins = [
    new BABYLON.Vector3(0, 2, 0),    // Centro
    new BABYLON.Vector3(1, 2, 0),    // Derecha
    new BABYLON.Vector3(-1, 2, 0),   // Izquierda
    new BABYLON.Vector3(0, 2, 1),    // Frente
    new BABYLON.Vector3(0, 2, -1)    // Atrás
  ];
  
  let groundHeight = null;
  
  rayOrigins.forEach(offset => {
    const rayOrigin = carMesh.position.add(offset);
    const ray = new BABYLON.Ray(rayOrigin, new BABYLON.Vector3(0, -1, 0), 10);
    const hit = scene.pickWithRay(ray);
    
    if (hit.hit && hit.pickedMesh !== carMesh) {
      if (groundHeight === null || hit.pickedPoint.y > groundHeight) {
        groundHeight = hit.pickedPoint.y;
      }
    }
  });
  
  // Ajustar altura del coche
  if (groundHeight !== null) {
    const targetHeight = groundHeight + 0.5;
    if (Math.abs(carMesh.position.y - targetHeight) > 0.1) {
      carMesh.position.y = targetHeight;
    }
  }
}

window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>