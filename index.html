<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Recorrido Circuito SPA - Movimiento Horizontal Sin Rebotes</title>
<style>
  html,body{margin:0;overflow:hidden;background:#000}
  #renderCanvas{width:100%;height:100%}
  #joystick-container{position:absolute;bottom:30px;left:30px;width:150px;height:150px;z-index:10}
  .button{position:absolute;bottom:30px;width:60px;height:60px;background:rgba(255,255,255,0.2);border-radius:50%;pointer-events:auto;}
  #btnForward{right:100px} #btnBackward{right:180px}
  #speedBarContainer{position:absolute;top:10px;left:10px;width:200px;height:20px;background:#444;border:1px solid #fff}
  #speedBar{height:100%;width:0%;background:#0f0;transition:width .3s}
  #debug{position:absolute;top:40px;left:10px;color:#fff;font-size:14px;font-family:monospace;}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<div id="joystick-container"></div>
<div id="speedBarContainer"><div id="speedBar"></div></div>
<div id="debug">Cargando circuito SPA...</div>
<div class="button" id="btnForward"></div>
<div class="button" id="btnBackward"></div>

<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>

<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas,true);
const scene = new BABYLON.Scene(engine);
scene.preventDefaultOnDoubleClick = false;
scene.collisionsEnabled = true;

// Crear mesh del jugador sin físicas
const playerMesh = BABYLON.MeshBuilder.CreateCapsule("player", {
  height: 1.8,
  radius: 0.3
}, scene);
playerMesh.isVisible = false;
playerMesh.checkCollisions = true;
playerMesh.ellipsoid = new BABYLON.Vector3(0.5, 0.9, 0.5);
playerMesh.ellipsoidOffset = new BABYLON.Vector3(0, 0.9, 0);

// Cámara
const camera = new BABYLON.FreeCamera("fpCamera", new BABYLON.Vector3(0, 2, 0), scene);
camera.parent = playerMesh;
camera.rotation = new BABYLON.Vector3(0, 0, 0);
camera.checkCollisions = false;
camera.applyGravity = false;
camera.speed = 0;
camera.angularSensibility = 2000;

// Luces
new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

const debug = document.getElementById("debug");

// Joystick
let joyX = 0;
const joystick = nipplejs.create({
  zone: document.getElementById("joystick-container"),
  mode: "static", position:{left:"75px",bottom:"75px"},
  size:120, color:"white"
});
joystick.on("move", (_,d)=>{ joyX = d.vector.x; });
joystick.on("end", ()=>{ joyX = 0; });

// Cargar circuito SIN FÍSICAS
BABYLON.SceneLoader.Append("", "spa.glb", scene, (scene) => {
  scene.meshes.forEach(mesh => {
    if (mesh !== playerMesh) mesh.checkCollisions = true;
  });

  playerMesh.position.set(-3780, 330, -3980);
  debug.textContent = "Circuito cargado - Movimiento horizontal activo";
});

// Mantener jugador pegado al suelo
function keepPlayerOnGround() {
  const ray = new BABYLON.Ray(
    playerMesh.position.add(new BABYLON.Vector3(0, 10, 0)),
    new BABYLON.Vector3(0, -1, 0),
    50
  );
  const hit = scene.pickWithRay(ray, (m)=>m!==playerMesh);
  if (hit && hit.hit) playerMesh.position.y = hit.pickedPoint.y + 1.8;
}

// Bucle principal
engine.runRenderLoop(() => {

  // --- MOVIMIENTO SOLO HORIZONTAL (INVERTIDO) ---
  if (Math.abs(joyX) > 0.05) {
    const lateralSpeed = -joyX * 0.3; // invertido

    const right = new BABYLON.Vector3(
      Math.cos(camera.rotation.y),
      0,
      -Math.sin(camera.rotation.y)
    );

    playerMesh.moveWithCollisions(right.scale(lateralSpeed));
  }

  keepPlayerOnGround();

  debug.textContent = `Pos: ${playerMesh.position.x.toFixed(1)}, ${playerMesh.position.y.toFixed(1)}, ${playerMesh.position.z.toFixed(1)}`;

  scene.render();
});

window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
