<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>SPA - Motor Sonoro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html,body{margin:0;overflow:hidden;height:100%;background:#6c7a89;}
  #renderCanvas{width:100%;height:100%;}
  .button{position:absolute;bottom:30px;width:80px;height:80px;background:rgba(255,255,255,0.25);border-radius:50%;pointer-events:auto;}
  #btnForward{right:40px} #btnBackward{right:140px}
  #speedBarContainer{position:absolute;top:10px;left:10px;width:200px;height:20px;background:#444;border:1px solid #fff}
  #speedBar{height:100%;width:0%;background:#0f0;transition:width .15s}
  #debug{position:absolute;top:40px;left:10px;color:#fff;font-size:14px;font-family:monospace;z-index:9;}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<div id="btnForward" class="button" title="Acelerar"></div>
<div id="btnBackward" class="button" title="Frenar"></div>
<div id="speedBarContainer"><div id="speedBar"></div></div>
<div id="debug">Cargando...</div>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>
<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas,true);
const scene = new BABYLON.Scene(engine);

// PLAYER
const playerMesh = BABYLON.MeshBuilder.CreateCapsule("player",{height:1.8,radius:0.3},scene);
playerMesh.isVisible=false; playerMesh.checkCollisions=true;
playerMesh.ellipsoid=new BABYLON.Vector3(0.5,3,0.5);
playerMesh.ellipsoidOffset=new BABYLON.Vector3(0,2,0);

// CAMERA
const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0,3,0), scene);
camera.parent = playerMesh; camera.attachControl(canvas,true);

// LIGHT
new BABYLON.HemisphericLight("h", new BABYLON.Vector3(0,1,0), scene);

// MOVIMIENTO
let moveForward=false, moveBackward=false, currentSpeed=0;
const maxSpeed=330, maxReverseSpeed=50, accel=50, brakeFriction=150, airFriction=8;

document.getElementById("btnForward").addEventListener("touchstart",()=>moveForward=true);
document.getElementById("btnForward").addEventListener("touchend",()=>moveForward=false);
document.getElementById("btnBackward").addEventListener("touchstart",()=>moveBackward=true);
document.getElementById("btnBackward").addEventListener("touchend",()=>moveBackward=false);

// SONIDO DEL MOTOR
let engineSound = null;
let audioInitialized=false;
function initEngineSound(){
    if(audioInitialized) return;
    engineSound = new BABYLON.Sound("engineSound", "motor.mp3", scene, null, {loop:true, autoplay:true, volume:0.5});
    audioInitialized=true;
}

// SPEEDBAR
const speedBar = document.getElementById("speedBar");
const debug = document.getElementById("debug");

// LOOP principal
let lastSpeed=0, currentPitch=0.6, targetPitch=0.6, currentVolume=0.5, targetVolume=0.5;
engine.runRenderLoop(()=>{
    const dt = engine.getDeltaTime()/1000;

    // inicializar audio al primer toque
    if((moveForward||moveBackward) && !audioInitialized) initEngineSound();

    // MOVIMIENTO
    if(moveForward && !moveBackward) currentSpeed=Math.min(currentSpeed+accel*dt,maxSpeed);
    else if(moveBackward && !moveForward) { 
        if(currentSpeed>0) currentSpeed=Math.max(currentSpeed-brakeFriction*dt,0);
        else currentSpeed=Math.max(currentSpeed-accel*dt,-maxReverseSpeed);
    } else { 
        if(currentSpeed>0) currentSpeed=Math.max(currentSpeed-airFriction*dt,0); 
        else if(currentSpeed<0) currentSpeed=Math.min(currentSpeed+airFriction*dt,0); 
    }

    // MOVER PLAYER
    if(Math.abs(currentSpeed)>0.001){
        const yaw=camera.rotation.y;
        const forward=new BABYLON.Vector3(Math.sin(yaw),0,Math.cos(yaw));
        playerMesh.moveWithCollisions(forward.scale(currentSpeed*dt));
    }

    // SPEEDBAR
    const speedNorm = Math.min(Math.abs(currentSpeed)/maxSpeed,1);
    speedBar.style.width=(speedNorm*100)+"%";
    speedBar.style.background=currentSpeed>=0?"#0f0":"#f00";

    // AUDIO: pitch y volumen según velocidad/aceleración
    if(audioInitialized && engineSound.isPlaying){
        const accelInstant = (currentSpeed-lastSpeed)/dt;
        const accelInfluence = Math.max(-1,Math.min(1,accelInstant/(accel*4)));

        targetPitch = 0.5 + speedNorm*1.4 + accelInfluence*0.12;
        targetPitch = Math.max(0.35, Math.min(2.2, targetPitch));
        targetVolume = 0.5 + speedNorm*0.5 + (moveForward?Math.max(0,accelInfluence)*0.25:0);
        targetVolume = Math.max(0.2, Math.min(1.0, targetVolume));

        const lerp = 1 - Math.exp(-6*dt);
        currentPitch += (targetPitch - currentPitch)*lerp;
        currentVolume += (targetVolume - currentVolume)*lerp;

        engineSound.setPlaybackRate(currentPitch);
        engineSound.setVolume(currentVolume);

        lastSpeed=currentSpeed;
    }

    debug.textContent=`Velocidad: ${currentSpeed.toFixed(0)} | Pitch: ${currentPitch.toFixed(2)}`;
    scene.render();
});

window.addEventListener('resize',()=>engine.resize());
</script>
</body>
</html>
