<!DOCTYPE html>
<html>
<head>
    <title>Circuito de Jerez - Vista en Primera Persona</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <div id="info">
        Movimiento: WASD | Mirar: Ratón | Correr: Shift | Saltar: Espacio
    </div>

    <script>
        // Obtener el canvas
        const canvas = document.getElementById("renderCanvas");
        
        // Crear el motor de Babylon.js
        const engine = new BABYLON.Engine(canvas, true);
        
        // Crear la escena
        const createScene = function () {
            const scene = new BABYLON.Scene(engine);
            
            // Crear cámara
            const camera = new BABYLON.FreeCamera("fpCamera", new BABYLON.Vector3(0, 2, 0), scene);
            camera.attachControl(canvas, true);
            
            // Configurar cámara en primera persona
            camera.inputs.addMouse();
            camera.keysUp = [87];    // W
            camera.keysDown = [83];  // S
            camera.keysLeft = [65];  // A
            camera.keysRight = [68]; // D
            camera.speed = 0.5;
            camera.angularSensibility = 2000;
            camera.applyGravity = true;
            camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
            camera.checkCollisions = true;
            camera.minZ = 0.1;
            
            // Crear luz
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.8;
            
            // Luz direccional adicional
            const sunLight = new BABYLON.DirectionalLight("sunLight", new BABYLON.Vector3(-1, -2, -1), scene);
            sunLight.intensity = 0.5;
            sunLight.position = new BABYLON.Vector3(20, 40, 20);
            
            // Crear cielo
            const skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size: 1000}, scene);
            const skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("https://assets.babylonjs.com/textures/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skybox.material = skyboxMaterial;
            
            // Crear suelo básico mientras se carga el circuito
            const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 100, height: 100}, scene);
            const groundMaterial = new BABYLON.StandardMaterial("groundMat", scene);
            groundMaterial.diffuseColor = new BABYLON.Color3(0.3, 0.5, 0.3);
            ground.material = groundMaterial;
            ground.checkCollisions = true;
            ground.receiveShadows = true;
            
            // Cargar el circuito de Jerez
            BABYLON.SceneLoader.ImportMesh("", "./", "jerez.obj", scene, function (meshes) {
                console.log("Circuito cargado:", meshes.length + " mallas");
                
                // Configurar colisiones y sombras para todas las mallas del circuito
                meshes.forEach(mesh => {
                    mesh.checkCollisions = true;
                    mesh.receiveShadows = true;
                    
                    // Aplicar material al circuito
                    const circuitMaterial = new BABYLON.StandardMaterial("circuitMat", scene);
                    circuitMaterial.diffuseColor = new BABYLON.Color3(0.7, 0.7, 0.7);
                    circuitMaterial.specularColor = new BABYLON.Color3(0.2, 0.2, 0.2);
                    mesh.material = circuitMaterial;
                });
                
                // Ocultar el suelo temporal
                ground.setEnabled(false);
                
                // Posicionar la cámara en un punto de partida
                camera.position = new BABYLON.Vector3(0, 2, -10);
                
                console.log("Circuito de Jerez listo para explorar en primera persona!");
                
            }, null, function (scene, message) {
                console.error("Error cargando el circuito:", message);
                
                // Mostrar mensaje de error si no se encuentra el archivo
                const errorDiv = document.createElement("div");
                errorDiv.style.cssText = "position: absolute; top: 50px; left: 10px; background: rgba(255,0,0,0.8); color: white; padding: 10px; border-radius: 5px;";
                errorDiv.innerHTML = "Error: No se pudo cargar jerez.obj. Asegúrate de que el archivo esté en la misma carpeta.";
                document.body.appendChild(errorDiv);
            });
            
            // Habilitar colisiones en la escena
            scene.collisionsEnabled = true;
            
            // Configurar gravedad
            scene.gravity = new BABYLON.Vector3(0, -0.5, 0);
            
            return scene;
        };
        
        // Crear la escena
        const scene = createScene();
        
        // Render loop
        engine.runRenderLoop(function () {
            scene.render();
        });
        
        // Manejar redimensionado de ventana
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
</body>
</html>