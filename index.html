<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>SPA - Control por Giroscopio PRO (GyroNorm)</title>
<style>
  html,body{margin:0;overflow:hidden;background:#000}
  #renderCanvas{width:100%;height:100%}
  .button{position:absolute;bottom:30px;width:80px;height:80px;background:rgba(255,255,255,0.25);border-radius:50%;pointer-events:auto;}
  #btnForward{right:40px}
  #btnBackward{right:140px}
  #speedBarContainer{position:absolute;top:10px;left:10px;width:200px;height:20px;background:#444;border:1px solid #fff}
  #speedBar{height:100%;width:0%;background:#0f0;transition:width .15s}
  #debug{position:absolute;top:40px;left:10px;color:#fff;font-size:14px;font-family:monospace;z-index:9}
  #settingsBtn{position:absolute;top:10px;right:10px;font-size:32px;color:white;z-index:20;cursor:pointer;}
  #settingsPanel{position:absolute;top:60px;right:10px;width:220px;padding:10px;background:rgba(0,0,0,0.85);color:white;border-radius:10px;display:none;z-index:20;}
  #calibrateBtn{width:100%;padding:10px;font-size:16px;border-radius:8px;}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<div id="speedBarContainer"><div id="speedBar"></div></div>
<div id="debug">Cargando circuito...</div>
<div class="button" id="btnForward"></div>
<div class="button" id="btnBackward"></div>
<div id="settingsBtn">⚙️</div>
<div id="settingsPanel">
  <h3 style="margin:0 0 10px 0;">Calibración</h3>
  <button id="calibrateBtn">Calibrar Giroscopio</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/gyronorm/dist/gyronorm.complete.min.js"></script>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>

<script>
// *** SOLO MÓVIL ***
if (!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    alert("Esta aplicación solo funciona en móviles.");
}

// *** BLOQUEAR A LANDSCAPE ***
if (screen.orientation && screen.orientation.lock) {
    screen.orientation.lock("landscape").catch(()=>{});
}

const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas,true);
const scene = new BABYLON.Scene(engine);
scene.collisionsEnabled = true;

// PLAYER
const playerMesh = BABYLON.MeshBuilder.CreateCapsule("player", {height:1.8, radius:0.3}, scene);
playerMesh.isVisible = false;
playerMesh.checkCollisions = true;
playerMesh.ellipsoid = new BABYLON.Vector3(0.5,0.9,0.5);
playerMesh.ellipsoidOffset = new BABYLON.Vector3(0,0.9,0);

// CÁMARA
const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0,2,0), scene);
camera.parent = playerMesh;
camera.checkCollisions = false;
camera.applyGravity = false;

// Permitir solo movimiento horizontal con giroscopio (NO ratón)
camera.inputs.clear();

// LUZ
new BABYLON.HemisphericLight("h", new BABYLON.Vector3(0,1,0), scene);

// UI
const debug = document.getElementById("debug");
const speedBar = document.getElementById("speedBar");

// ACELERACIÓN
let moveForward=false, moveBackward=false;
let currentSpeed=0;
const maxSpeed=300;
const maxReverseSpeed=5;
const accel=80;
const decel=90;
const airFriction=10;

// BOTONES
const btnF=document.getElementById("btnForward");
const btnB=document.getElementById("btnBackward");
btnF.addEventListener("touchstart",()=>moveForward=true);
btnF.addEventListener("touchend",()=>moveForward=false);
btnB.addEventListener("touchstart",()=>moveBackward=true);
btnB.addEventListener("touchend",()=>moveBackward=false);

// PANEL DE AJUSTES
const settingsBtn=document.getElementById("settingsBtn");
const settingsPanel=document.getElementById("settingsPanel");
settingsBtn.onclick=()=>{
    settingsPanel.style.display = settingsPanel.style.display=="none" ? "block" : "none";
};

// GIROSCOPIO PRO (GYRONORM)
let tilt=0;
let calibrationOffset=0;

const gn=new GyroNorm();

gn.init({
    frequency:30,
    gravityNormalized:true,
    orientationBase:GyroNorm.GAME,
    decimalCount:3,
    screenAdjusted:true
}).then(()=>{
    gn.start(data=>{
        tilt = data.do.gamma; // izquierda/derecha REAL
    });
}).catch(()=>{
    alert("No se puede acceder al giroscopio.");
});

// BOTÓN CALIBRAR
calibrateBtn.onclick=()=>{
    calibrationOffset = tilt;
    alert("Giroscopio calibrado");
};

// CARGAR CIRCUITO
BABYLON.SceneLoader.Append("", "spa.glb", scene, ()=>{
    scene.meshes.forEach(m=>{ if(m!==playerMesh) m.checkCollisions=true; });
    playerMesh.position.set(-3780,330,-3980);
    debug.textContent="Listo - Giroscopio activo";
});

// Suelo
function keepGround(){
  const ray=new BABYLON.Ray(playerMesh.position.add(new BABYLON.Vector3(0,10,0)),new BABYLON.Vector3(0,-1,0),50);
  const hit=scene.pickWithRay(ray,m=>m!==playerMesh);
  if(hit&&hit.hit) playerMesh.position.y = hit.pickedPoint.y + 1.8;
}

// LOOP
engine.runRenderLoop(()=>{
  const dt=engine.getDeltaTime()/1000;

  // VELOCIDAD
  if(moveForward&&!moveBackward) currentSpeed=Math.min(currentSpeed+accel*dt,maxSpeed);
  else if(moveBackward&&!moveForward) currentSpeed=Math.max(currentSpeed-accel*dt,-maxReverseSpeed);
  else {
    if(currentSpeed>0) currentSpeed=Math.max(currentSpeed-airFriction*dt,0);
    else if(currentSpeed<0) currentSpeed=Math.min(currentSpeed+airFriction*dt,0);
  }

  speedBar.style.width=(Math.abs(currentSpeed)/maxSpeed*100)+"%";
  speedBar.style.background=currentSpeed>=0?"#0f0":"#f00";

  // AVANCE
  if(Math.abs(currentSpeed)>0.1){
      const f=new BABYLON.Vector3(Math.sin(camera.rotation.y),0,Math.cos(camera.rotation.y));
      playerMesh.moveWithCollisions(f.scale(currentSpeed*dt));
  }

  // LATERAL CON GYRONORM
  const correctedTilt = tilt - calibrationOffset;
  if(Math.abs(correctedTilt) > 1){
      const side=new BABYLON.Vector3(Math.cos(camera.rotation.y),0,-Math.sin(camera.rotation.y));
      const sideSpeed = (correctedTilt / 45) * 60;
      playerMesh.moveWithCollisions(side.scale(sideSpeed * dt));
  }

  keepGround();

  debug.textContent=`Tilt: ${tilt.toFixed(1)} | Offset: ${calibrationOffset.toFixed(1)} | Vel: ${currentSpeed.toFixed(1)}`;

  scene.render();
});

window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
