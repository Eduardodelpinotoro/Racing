<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>SPA - Juego de Carreras 1ª/3ª Persona</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;overflow:hidden;height:100%;background:#000}
#renderCanvas{width:100%;height:100%}
.button{position:absolute;bottom:30px;width:80px;height:80px;background:rgba(255,255,255,0.25);border-radius:50%;pointer-events:auto;}
#btnForward{right:40px} #btnBackward{right:140px}
#speedBarContainer{position:absolute;top:10px;left:10px;width:200px;height:20px;background:#444;border:1px solid #fff}
#speedBar{height:100%;width:0%;background:#0f0;transition:width .15s}
#joystickContainer { position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px; pointer-events: auto; z-index: 10; }
#joystickBase { position: absolute; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.15); border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.3); }
#joystickHandle { position: absolute; width: 60px; height: 60px; background: rgba(255, 255, 255, 0.4); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.05s; }
#modeBtn{position:absolute;top:10px;left:10px;padding:10px 15px;background:rgba(0,0,0,0.5);color:#0f0;border:2px solid #0f0;border-radius:5px;z-index:100;cursor:pointer;}
#timerPanel{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:120px;background:rgba(0,0,0,0.7);border:2px solid #fff;border-radius:10px;padding:10px;color:#fff;font-family:monospace;font-size:10px;text-align:center;}
#currentTimer{font-size:12px;color:#0f0;margin-bottom:5px;}
#lapTimes{font-size:8px;max-height:60px;overflow-y:auto;}
.lap-time{padding:1px 0;border-bottom:1px solid #444;}
.best-lap{color:#ff0;font-weight:bold;}
#timerStatus{font-size:12px;color:#0ff;margin-top:2px;}
#bestLapDisplay{font-size:12px;color:#ff0;margin-top:2px;}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>

<div class="button" id="btnForward" title="Acelerar"></div>
<div class="button" id="btnBackward" title="Freno / marcha atrás"></div>
<div id="joystickContainer">
  <div id="joystickBase"><div id="joystickHandle"></div></div>
</div>

<button id="modeBtn">Modo: 3ª Persona</button>

<div id="timerPanel">
  <div id="currentTimer">00:00.000</div>
  <div id="lapTimes"></div>
  <div id="timerStatus">ESPERANDO EN META</div>
  <div id="bestLapDisplay">MEJOR VUELTA: --:--.---</div>
</div>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>
<script>
// ========== ESCENA ==========
const canvas=document.getElementById("renderCanvas");
const engine=new BABYLON.Engine(canvas,true);
const scene=new BABYLON.Scene(engine);
scene.collisionsEnabled=true;
scene.clearColor=new BABYLON.Color4(0.4,0.7,1,1);

// LUCES
const hemiLight=new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0,1,0), scene);
hemiLight.intensity=1.2;
const dirLight=new BABYLON.DirectionalLight("sun", new BABYLON.Vector3(-0.5,-1,0.5), scene);
dirLight.intensity=0.8;

// ========== PLAYER ==========
const playerMesh=BABYLON.MeshBuilder.CreateCapsule("player",{height:1.8,radius:0.3},scene);
playerMesh.isVisible=false;
playerMesh.checkCollisions=true;
playerMesh.ellipsoid=new BABYLON.Vector3(0.5,1,0.5);
playerMesh.ellipsoidOffset=new BABYLON.Vector3(0,0.9,0);

// Importar Lambo
let carPivot=null, lamboVisible=true;
BABYLON.SceneLoader.ImportMesh("", "https://cdn.jsdelivr.net/gh/Eduardodelpinotoro/Racing/", "lambo.glb", scene, function(meshes){
    carPivot=new BABYLON.TransformNode("carPivot", scene);
    carPivot.parent = playerMesh;
    carPivot.scaling = new BABYLON.Vector3(0.1,0.1,0.1);
    meshes.forEach(m => { if(m instanceof BABYLON.Mesh){ m.parent=carPivot; m.rotationQuaternion=null; m.scaling=new BABYLON.Vector3(1,1,1); } });
    carPivot.position = new BABYLON.Vector3(0,-0.9,0);
});

// ========== CAMARAS ==========
let thirdCamera = new BABYLON.FollowCamera("third", new BABYLON.Vector3(4,3,-6), scene);
thirdCamera.lockedTarget = playerMesh;
thirdCamera.radius = 6; thirdCamera.heightOffset=3; thirdCamera.rotationOffset=0; thirdCamera.cameraAcceleration=0.05; thirdCamera.maxCameraSpeed=20;

let firstCamera = new BABYLON.FreeCamera("first", new BABYLON.Vector3(0,1.2,0), scene);
firstCamera.parent = playerMesh;

let isThird=true;
scene.activeCamera=thirdCamera;
scene.activeCamera.attachControl(canvas,true);

document.getElementById("modeBtn").addEventListener('click', ()=>{
    isThird=!isThird;
    scene.activeCamera=isThird?thirdCamera:firstCamera;
    carPivot && (carPivot.isVisible=isThird); // mostrar coche solo en 3ª persona
    document.getElementById("modeBtn").textContent = isThird?"Modo: 3ª Persona":"Modo: 1ª Persona";
});

// ========== CONTROLES ==========
let moveForward=false, moveBackward=false, joystickRotation=0, currentSpeed=0;
let maxSpeed=330, accel=50, brakeFriction=150, rotationSpeed=2;
document.getElementById("btnForward").addEventListener("touchstart",()=>moveForward=true);
document.getElementById("btnForward").addEventListener("touchend",()=>moveForward=false);
document.getElementById("btnBackward").addEventListener("touchstart",()=>moveBackward=true);
document.getElementById("btnBackward").addEventListener("touchend",()=>moveBackward=false);

// Joystick
const joystickContainer=document.getElementById("joystickContainer");
const joystickHandle=document.getElementById("joystickHandle");
let isJoystickActive=false;
joystickContainer.addEventListener('touchstart', e=>{ e.preventDefault(); isJoystickActive=true; updateJoystick(e.touches[0]); });
joystickContainer.addEventListener('touchmove', e=>{ e.preventDefault(); if(isJoystickActive) updateJoystick(e.touches[0]); });
joystickContainer.addEventListener('touchend', e=>{ isJoystickActive=false; resetJoystick(); });
function updateJoystick(touch){ const rect=joystickContainer.getBoundingClientRect(); const dx=touch.clientX-(rect.left+rect.width/2); const maxDist=rect.width/2-joystickHandle.offsetWidth/2; const dist=Math.min(Math.abs(dx), maxDist); joystickHandle.style.transform=`translate(calc(-50% + ${Math.sign(dx)*dist}px), -50%)`; joystickRotation=Math.max(-1,Math.min(1,dx/maxDist)); }
function resetJoystick(){ joystickHandle.style.transform='translate(-50%,-50%)'; joystickRotation=0; }

// ========== HUD ==========
const currentTimer=document.getElementById("currentTimer");
const lapTimes=document.getElementById("lapTimes");
const timerStatus=document.getElementById("timerStatus");
const bestLapDisplay=document.getElementById("bestLapDisplay");
let raceStartTime=0,currentLapStartTime=0,bestLapTime=0,lapCount=0,isRacing=false;
function formatTime(ms){const m=Math.floor(ms/60000),s=Math.floor((ms%60000)/1000),msr=Math.floor(ms%1000); return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${msr.toString().padStart(3,'0')}`;}
function updateTimerDisplay(){ currentTimer.textContent=isRacing?formatTime(Date.now()-currentLapStartTime):"00:00.000"; bestLapDisplay.textContent=bestLapTime>0?`MEJOR VUELTA: ${formatTime(bestLapTime)}`:"MEJOR VUELTA: --:--.---"; }

// ========== MOTOR ==========
engine.runRenderLoop(()=>{
    const dt = engine.getDeltaTime()/1000;
    // Aceleración/freno
    if(moveForward && !moveBackward) currentSpeed=Math.min(currentSpeed+accel*dt,maxSpeed);
    else if(moveBackward && !moveForward) currentSpeed=Math.max(currentSpeed-brakeFriction*dt,-maxSpeed/2);
    else currentSpeed *=0.95; // fricción

    // Rotación
    if(Math.abs(currentSpeed)>1) playerMesh.rotation.y += joystickRotation*rotationSpeed*dt;

    // Movimiento
    const forward=new BABYLON.Vector3(Math.sin(playerMesh.rotation.y),0,Math.cos(playerMesh.rotation.y));
    playerMesh.moveWithCollisions(forward.scale(currentSpeed*dt));

    // Speed bar
    const speedBar=document.getElementById("speedBar");
    const speedPercent=Math.min(Math.abs(currentSpeed)/maxSpeed,1)*100;
    speedBar.style.width=speedPercent+"%";
    speedBar.style.background=currentSpeed>=0?"#0f0":"#f00";

    updateTimerDisplay();
    scene.render();
});

window.addEventListener('resize',()=>engine.resize());
</script>
</body>
</html>
