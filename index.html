<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>SPA - Juego de Carreras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
html,body{margin:0;overflow:hidden;height:100%;background:#000}
#renderCanvas{width:100%;height:100%}
.button{position:absolute;bottom:30px;width:80px;height:80px;background:rgba(255,255,255,0.25);border-radius:50%;pointer-events:auto;}
#btnForward{right:40px}
#btnBackward{right:140px}
#speedBarContainer{position:absolute;top:10px;left:10px;width:200px;height:20px;background:#444;border:1px solid #fff}
#speedBar{height:100%;width:0%;background:#0f0;transition:width .15s}
#debug{position:absolute;top:40px;left:10px;color:#fff;font-size:14px;font-family:monospace;z-index:9}
#joystickContainer { position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px; pointer-events: auto; z-index: 10; }
#joystickBase { position: absolute; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.15); border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.3); }
#joystickHandle { position: absolute; width: 60px; height: 60px; background: rgba(255, 255, 255, 0.4); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.05s; }
#joystickAxis { position: absolute; width: 100%; height: 4px; background: rgba(255, 255, 255, 0.2); top: 50%; left: 0; transform: translateY(-50%); }
.joystick-disabled { opacity: 0.5; pointer-events: none; }
#timerPanel {position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 100px; background: rgba(0,0,0,0.7); border: 2px solid #fff; border-radius: 10px; padding: 10px; color: #fff; font-family: monospace; z-index: 100; font-size: 10px; text-align: center;}
#currentTimer { font-size: 12px; text-align: center; margin-bottom: 5px; color: #0f0; }
#lapTimes { font-size: 8px; max-height: 60px; overflow-y: auto; }
.lap-time { padding: 1px 0; border-bottom: 1px solid #444; }
.lap-time:last-child { border-bottom: none; }
.best-lap { color: #ff0; font-weight: bold; }
#timerStatus { text-align: center; font-size: 12px; margin-top: 2px; color: #0ff; }
#bestLapDisplay { text-align: center; font-size: 12px; margin-top: 2px; color: #ff0; }
#fullscreenBtn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);padding:15px 25px;font-size:20px;background:rgba(0,0,0,0.7);color:#0f0;border:2px solid #0f0;border-radius:10px;z-index:100;}
#settingsBtn{position:absolute;top:10px;right:10px;width:50px;height:50px;background:rgba(255,255,255,0.25);border-radius:50%;font-size:28px;text-align:center;line-height:50px;cursor:pointer;z-index:100;}
#settingsPanel {position: absolute; top: 0%; left: 50%; transform: translateX(-50%); width: 260px; background: rgba(0, 0, 0, 0.8); padding: 20px; border-radius: 12px; color: white; display: none; z-index: 999; backdrop-filter: blur(5px); transition: 0.3s ease; max-height: 70vh; overflow-y: auto;}
#settingsPanel label{display:block;margin:5px 0 2px;}
#settingsPanel input[type=range]{width:100%;}
#settingsPanel select, #settingsPanel input[type=number]{width:100%;margin-bottom:5px;}
#settingsPanel button{width:100%;padding:5px;margin-top:5px;}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>

<div id="speedBarContainer"><div id="speedBar"></div></div>
<div id="debug">Cargando circuito...</div>
<div class="button" id="btnForward" title="Acelerar"></div>
<div class="button" id="btnBackward" title="Freno / marcha atrás"></div>
<div id="joystickContainer">
  <div id="joystickBase">
    <div id="joystickAxis"></div>
    <div id="joystickHandle"></div>
  </div>
</div>

<div id="timerPanel">
  <div id="currentTimer">00:00.000</div>
  <div id="lapTimes"></div>
  <div id="timerStatus">ESPERANDO EN META</div>
  <div id="bestLapDisplay">MEJOR VUELTA: --:--.---</div>
</div>

<button id="fullscreenBtn">Pantalla Completa</button>
<div id="settingsBtn">⚙️</div>
<div id="settingsPanel">
    <label>Velocidad Máx: <span id="maxSpeedLabel">330</span></label>
    <input type="range" id="maxSpeedRange" min="50" max="500" value="330">
    <label>Aceleración: <span id="accelLabel">50</span></label>
    <input type="range" id="accelRange" min="10" max="200" value="50">
    <label>Freno: <span id="brakeLabel">150</span></label>
    <input type="range" id="brakeRange" min="20" max="300" value="150">
    <label>Clima</label>
    <select id="weatherSelect">
        <option value="sunny">Soleado</option>
        <option value="gray">Cielo Gris</option>
        <option value="sunset">Atardecer Azul</option>
    </select>
    <label>Niebla: <span id="fogLabel">0.00</span></label>
    <input type="range" id="fogRange" min="0" max="0.04" step="0.01" value="0">
    <label>Intensidad de Luz: <span id="lightLabel">0.8</span></label>
    <input type="range" id="lightRange" min="0" max="2" step="0.01" value="0.8">
    <label>Música</label>
    <button id="musicBtn">On</button>
    <label>Número de Vueltas</label>
    <input type="number" id="lapsNumber" min="1" max="99" value="3">
    <button id="gotoStartBtn">Ir a Meta</button>
</div>
<audio id="motorAudio" src="motor.mp3" loop></audio>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>
<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas,true);
const scene = new BABYLON.Scene(engine);
scene.clearColor = new BABYLON.Color4(0.4,0.7,1,1);
scene.fogMode = BABYLON.Scene.FOGMODE_EXP2;
scene.fogColor = new BABYLON.Color3(0.5,0.5,0.5);

// Luces
const hemiLight = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0,1,0), scene);
hemiLight.intensity=1.2;
const dirLight = new BABYLON.DirectionalLight("sun", new BABYLON.Vector3(-0.5,-1,0.5), scene);
dirLight.intensity=0.8;

// =========================
// Player (cuerpo invisible)
const playerMesh = BABYLON.MeshBuilder.CreateBox("player",{height:1,width:0.6,depth:2},scene);
playerMesh.isVisible=false;
playerMesh.checkCollisions=true;
playerMesh.ellipsoid=new BABYLON.Vector3(0.5,0.6,1);
playerMesh.ellipsoidOffset=new BABYLON.Vector3(0,0.6,0);
playerMesh.applyGravity=true;

// Importar coche
BABYLON.SceneLoader.ImportMesh("", "https://cdn.jsdelivr.net/gh/Eduardodelpinotoro/Racing/", "lambo.glb", scene, function(meshes){
    const carPivot = new BABYLON.TransformNode("carPivot", scene);
    carPivot.parent = playerMesh;
    carPivot.scaling = new BABYLON.Vector3(0.1,0.1,0.1);
    meshes.forEach(m => { if(m instanceof BABYLON.Mesh){ m.parent = carPivot; m.rotationQuaternion=null; } });
    carPivot.position = new BABYLON.Vector3(0,-0.6,0);
});

// =========================
// Cámara FollowCamera
const camera = new BABYLON.FollowCamera("cam", new BABYLON.Vector3(4,8,0), scene);
camera.lockedTarget = playerMesh;
camera.radius = 6;
camera.heightOffset = 3;
camera.rotationOffset = 0;
camera.cameraAcceleration = 0.05;
camera.maxCameraSpeed = 20;

// =========================
// Controles
let moveForward=false, moveBackward=false, joystickRotation=0;
let currentSpeed=0, maxSpeed=330, accel=50, brakeFriction=150, rotationSpeed=2;

// Botones
document.getElementById("btnForward").addEventListener("touchstart",()=>moveForward=true);
document.getElementById("btnForward").addEventListener("touchend",()=>moveForward=false);
document.getElementById("btnBackward").addEventListener("touchstart",()=>moveBackward=true);
document.getElementById("btnBackward").addEventListener("touchend",()=>moveBackward=false);

// Joystick
const joystickContainer=document.getElementById("joystickContainer");
const joystickHandle=document.getElementById("joystickHandle");
let isJoystickActive=false;

joystickContainer.addEventListener('touchstart', e=>{ e.preventDefault(); isJoystickActive=true; updateJoystick(e.touches[0]); });
joystickContainer.addEventListener('touchmove', e=>{ e.preventDefault(); if(isJoystickActive) updateJoystick(e.touches[0]); });
joystickContainer.addEventListener('touchend', e=>{ e.preventDefault(); isJoystickActive=false; joystickRotation=0; joystickHandle.style.transform='translate(-50%,-50%)'; });

function updateJoystick(touch){
    const rect=joystickContainer.getBoundingClientRect();
    const dx=touch.clientX-(rect.left+rect.width/2);
    const maxDist=rect.width/2-joystickHandle.offsetWidth/2;
    const dist=Math.min(Math.abs(dx), maxDist);
    joystickHandle.style.transform=`translate(calc(-50% + ${Math.sign(dx)*dist}px), -50%)`;
    joystickRotation=Math.max(-1,Math.min(1,dx/maxDist));
}

// =========================
// HUD y Cronómetro
const currentTimer=document.getElementById("currentTimer");
const lapTimes=document.getElementById("lapTimes");
const timerStatus=document.getElementById("timerStatus");
const bestLapDisplay=document.getElementById("bestLapDisplay");
let raceStartTime=0,currentLapStartTime=0,bestLapTime=0,lapCount=0,isRacing=false,totalLaps=3;

const finishLine={minX:-3800,maxX:-3700,z:-4025,width:30};
finishLine.centerX=(finishLine.minX+finishLine.maxX)/2;
finishLine.resetThreshold=finishLine.width+10;
let hasCrossedFinishLine=false, prevPosZ=0;

function formatTime(ms){const m=Math.floor(ms/60000),s=Math.floor((ms%60000)/1000),msr=Math.floor(ms%1000); return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${msr.toString().padStart(3,'0')}`;}
function updateTimerDisplay(){ currentTimer.textContent=isRacing?formatTime(Date.now()-currentLapStartTime):"00:00.000"; bestLapDisplay.textContent=bestLapTime>0?`MEJOR VUELTA: ${formatTime(bestLapTime)}`:"MEJOR VUELTA: --:--.---"; }
function registerCross(){ 
    if(!isRacing){isRacing=true; raceStartTime=Date.now(); currentLapStartTime=raceStartTime; lapCount=1; timerStatus.textContent="VUELTA 1"; timerStatus.style.color="#0f0"; return; } 
    const lapTime=Date.now()-currentLapStartTime; 
    if(bestLapTime===0||lapTime<bestLapTime) bestLapTime=lapTime; 
    const lapEl=document.createElement("div"); 
    lapEl.className="lap-time"; 
    lapEl.textContent=`Vuelta ${lapCount}: ${formatTime(lapTime)}`+(lapTime===bestLapTime?" ★":""); 
    if(lapTime===bestLapTime) lapEl.classList.add("best-lap"); 
    lapTimes.insertBefore(lapEl,lapTimes.firstChild); 
    lapCount++; 
    currentLapStartTime=Date.now(); 
    if(lapCount>totalLaps){ timerStatus.textContent="CARRERA COMPLETADA"; isRacing=false; } else { timerStatus.textContent=`VUELTA ${lapCount}`; }
}
function checkFinishLine(){ const pos=playerMesh.position; const insideX=(pos.x>=finishLine.minX && pos.x<=finishLine.maxX); if(insideX){ if(!hasCrossedFinishLine && prevPosZ<finishLine.z && pos.z>=finishLine.z){ hasCrossedFinishLine=true; registerCross(); } else if(!hasCrossedFinishLine && prevPosZ>finishLine.z && pos.z<=finishLine.z){ hasCrossedFinishLine=true; registerCross(); } } else { hasCrossedFinishLine=false; } prevPosZ=pos.z; }

// =========================
// Engine loop
engine.runRenderLoop(()=>{
    const dt = engine.getDeltaTime()/1000;

    // Velocidad
    if(moveForward && !moveBackward) currentSpeed=Math.min(currentSpeed+accel*dt,maxSpeed);
    else if(moveBackward && !moveForward) currentSpeed=Math.max(currentSpeed-brakeFriction*dt,-maxSpeed);
    else currentSpeed *=0.95; // fricción

    // Rotación
    if(Math.abs(currentSpeed)>1) playerMesh.rotation.y += joystickRotation*rotationSpeed*dt;

    // Movimiento
    const forward = new BABYLON.Vector3(Math.sin(playerMesh.rotation.y),0,Math.cos(playerMesh.rotation.y));
    playerMesh.moveWithCollisions(forward.scale(currentSpeed*dt));

    // HUD
    checkFinishLine();
    updateTimerDisplay();

    // Speed bar
    const speedPercent=Math.min(Math.abs(currentSpeed)/maxSpeed,1)*100;
    const speedBar=document.getElementById("speedBar");
    speedBar.style.width=speedPercent+"%";
    speedBar.style.background=currentSpeed>=0?"#0f0":"#f00";

    // Render
    scene.render();
});
</script>
</body>
</html>
