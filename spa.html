<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>SPA Racing - Simulaci√≥n de Conducci√≥n Realista</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0a0a">
<script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
<style>
html,body{margin:0;overflow:hidden;height:100%;background:#000}
#renderCanvas{width:100%;height:100%}
.button{position:absolute;bottom:30px;width:80px;height:80px;background:rgba(255,255,255,0.25);border-radius:50%;pointer-events:auto;}
#btnForward{right:40px}
#btnBackward{right:140px}
#speedBarContainer{position:absolute;top:10px;left:100px;width:200px;height:20px;background:#444;border:1px solid #fff}
#speedBar{height:100%;width:0%;background:#0f0;transition:width .15s}
#debug{position:absolute;top:40px;left:10px;color:#fff;font-size:14px;font-family:monospace;z-index:9}
#joystickContainer { position: absolute; bottom: 30px; left: 50px; width: 160px; height: 120px; pointer-events: auto; z-index: 10; }
#joystickBase { position: absolute; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.15); border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.3); }
#joystickHandle { position: absolute; width: 50px; height: 100px; background: rgba(255, 255, 255, 0.4); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.05s; }
#joystickAxis { position: absolute; width: 100%; height: 1px; background: rgba(255, 255, 255, 0.2); top: 50%; left: 0; transform: translateY(-50%); }
.joystick-disabled { opacity: 0.5; pointer-events: none; }

/* CRON√ìMETRO MOVIDO A LA DERECHA ARRIBA */
#timerPanel { 
    position: absolute; 
    top: 50px; 
    left: 10px; 
    width: 100px; 
    background: rgba(0,0,0,0.7); 
    border: 2px solid #fff; 
    border-radius: 10px; 
    padding: 5px; 
    color: #fff; 
    font-family: monospace; 
    z-index: 10; 
    font-size: 12px;
}
#currentTimer { font-size: 18px; text-align: center; margin-bottom: 5px; color: #0f0; }
#lapTimes { font-size: 10px; max-height: 100px; overflow-y: auto; }
.lap-time { padding: 1px 0; border-bottom: 1px solid #444; }
.lap-time:last-child { border-bottom: none; }
.best-lap { color: #ff0; font-weight: bold; }
#timerStatus { text-align: center; font-size: 12px; margin-top: 2px; color: #0ff; }
#bestLapDisplay { text-align: center; font-size: 12px; margin-top: 2px; color: #ff0; }

/* Bot√≥n pantalla completa */
#fullscreenBtn{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    padding:15px 25px;
    font-size:20px;
    background:rgba(0,0,0,0.7);
    color:#0f0;
    border:2px solid #0f0;
    border-radius:10px;
    z-index:100;
}

/* Botones configuraci√≥n y coches */
#settingsBtn, #carsBtn {
    position:absolute;
    top:5px;
    width:40px;
    height:40px;
    background:rgba(255,255,255,0.25);
    border-radius:50%;
    font-size:28px;
    text-align:center;
    line-height:50px;
    cursor:pointer;
    z-index:100;
}
#settingsBtn{ left:100px; }
#carsBtn{ left:50px; font-size:30px; }

/* Paneles */
.settings-panel{
    position:absolute;
    top:60px;
    left:150px;
    width:240px;
    background:rgba(0,0,0,0.95);
    border:2px solid #fff;
    border-radius:10px;
    padding:15px;
    color:#fff;
    font-family:monospace;
    display:none;
    z-index:101;
    max-height:80vh;
    overflow-y:auto;
}
.settings-panel label{display:block;margin:8px 0 4px;font-size:14px;}
.settings-panel input[type=range]{width:100%;margin:5px 0;}
.settings-panel select, .settings-panel input[type=number]{width:100%;margin-bottom:8px;padding:4px;}
.settings-panel button{width:100%;padding:8px;margin-top:8px;}

/* Estilos espec√≠ficos para el panel de coches */
.car-option {
    padding: 10px;
    margin: 5px 0;
    background: rgba(255,255,255,0.1);
    border-radius: 5px;
    cursor: pointer;
    border: 1px solid transparent;
}
.car-option:hover {
    background: rgba(255,255,255,0.2);
    border-color: #0f0;
}
.car-option.selected {
    background: rgba(0,255,0,0.2);
    border-color: #0f0;
}
.car-stats {
    font-size: 12px;
    color: #ccc;
    margin-top: 5px;
}

/* Bot√≥n posici√≥n inicial */
#resetPositionBtn{
    position:absolute;
    top:5px;
    left:0px;
    width:40px;
    height:40px;
    background:rgba(255,255,255,0.25);
    border-radius:50%;
    pointer-events:auto;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:24px;
    color:white;
}

/* Sliders tipo volumen (acelerador/freno) - MEJORADOS */
.slider {
    position: absolute;
    bottom: 30px;
    width: 80px;
    height: 200px;
    background: rgba(255,255,255,0.06);
    border-radius: 20px;
    border: 2px solid rgba(255,255,255,0.08);
    touch-action: none;
    z-index: 20;
    display: flex;
    align-items: flex-end;
    overflow: hidden;
}
#throttleSlider{ right: 30px; }
#brakeSlider{ right: 130px; left: auto; }
.slider-fill {
    width: 100%;
    height: 0%;
    background: linear-gradient(180deg, rgba(0,255,0,0.25), rgba(0,255,0,0.6));
    border-radius: 16px 16px 6px 6px;
    transition: height 0.05s;
}
#brakeFill {
    background: linear-gradient(180deg, rgba(255,0,0,0.25), rgba(255,0,0,0.6));
}
.slider-label{position:absolute;top:-22px;right:0;font-size:12px;color:#fff;font-family:monospace}

/* Indicadores num√©ricos peque√±os */
.pedal-value{
    position:absolute;
    bottom:240px;
    right:30px;
    color:#fff;
    font-family:monospace;
    font-size:12px;
    z-index:21;
}
.pedal-value.brake{ right:130px; left: auto; }

/* Indicador de marcha */
#gearIndicator {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #fff;
    padding: 5px 15px;
    border-radius: 5px;
    font-size: 14px;
    font-family: monospace;
    z-index: 10;
    border: 1px solid #fff;
}

/* Indicador de velocidad num√©rico */
#speedNumber {
    position: absolute;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #0f0;
    padding: 5px 15px;
    border-radius: 5px;
    font-size: 18px;
    font-family: monospace;
    z-index: 10;
    border: 1px solid #0f0;
    font-weight: bold;
}

/* Indicador de RPM */
#rpmIndicator {
    position: absolute;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #0f0;
    padding: 5px 15px;
    border-radius: 5px;
    font-size: 16px;
    font-family: monospace;
    z-index: 10;
    border: 1px solid #0f0;
    display: flex;
    align-items: bottom;
    gap: 8px;
}

#rpmBar {
    width: 60px;
    height: 8px;
    background: #333;
    border-radius: 4px;
    overflow: hidden;
}

#rpmFill {
    height: 100%;
    width: 0%;
    background: #0f0;
    border-radius: 4px;
    transition: width 0.1s, background 0.3s;
}

/* Controles de cambio de marchas */
#gearControls {
    position: absolute;
    bottom: 250px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    gap: 20px;
    align-items: center;
    z-index: 25;
}

.gear-btn {
    width: 60px;
    height: 60px;
    background: rgba(255,255,255,0.2);
    border: 2px solid #fff;
    border-radius: 50%;
    color: #fff;
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s;
    z-index: 25;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    touch-action: manipulation;
    pointer-events: auto;
}

.gear-btn:active {
    background: rgba(255,255,255,0.4);
    transform: scale(0.95);
}

#gearDown {
    pointer-events: auto;
    position: absolute;
    top: 130px;
    left: 220px;
}

#gearUp {
    pointer-events: auto;
    position: absolute;
    top: 60px;
    left: 220px;
}

#gearModeBtn {
    position: absolute;
    bottom: 200px;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 40px;
    border-radius: 20px;
    font-size: 14px;
    background: rgba(0,255,0,0.3);
    border: 2px solid #0f0;
    color: #fff;
    cursor: pointer;
    z-index: 25;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    touch-action: manipulation;
}

#gearModeBtn.manual {
    background: rgba(255,255,0,0.3);
    border-color: #ff0;
}

/* Ocultar elementos no necesarios */
#speedBarContainer, #debug, #gyroIndicator, #gyroIndicatorBar, #orientationInfo {
    display: none !important;
}

/* SISTEMA DE DA√ëO */
#damageIndicator {
    position: absolute;
    top: 0px;
    right: 10px;
    width: 145px;
    height: 10px;
    background: rgba(0,0,0,0.7);
    border: 1px solid #fff;
    border-radius: 10px;
    z-index: 10;
    display: flex;
    align-items: center;
    padding: 0 5px;
}

#damageBar {
    height: 70%;
    width: 100%;
    background: #333;
    border-radius: 5px;
    overflow: hidden;
    position: relative;
}

#damageFill {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #0f0, #ff0, #f00);
    border-radius: 5px;
    transition: width 0.3s;
}

#damageText {
    position: absolute;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 10px;
    color: #fff;
    font-family: monospace;
    font-weight: bold;
    text-shadow: 1px 1px 1px #000;
}

#crashMessage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    color: #f00;
    padding: 20px 40px;
    border-radius: 10px;
    font-size: 24px;
    font-family: monospace;
    text-align: center;
    z-index: 100;
    border: 3px solid #f00;
    display: none;
    box-shadow: 0 0 20px rgba(255,0,0,0.5);
}

#crashMessage p {
    margin: 10px 0;
    font-size: 16px;
    color: #fff;
}

.damage-effect {
    position: absolute;
    top: 0;
    right: 10;
    width: 50%;
    height: 50%;
    pointer-events: none;
    z-index: 5;
    opacity: 0;
    transition: opacity 0.3s;
}

#screenCracks {
    background: radial-gradient(circle at 30% 30%, transparent 50%, rgba(255,0,0,0.1) 70%),
                radial-gradient(circle at 70% 70%, transparent 50%, rgba(255,0,0,0.1) 70%);
}

#redOverlay {
    background: rgba(255,0,0,0.1);
}

/* NUEVO: PANEL DE CLASIFICACI√ìN ONLINE */
.leaderboard-panel {
    position: absolute;
    top: 60px;
    left: 150px;
    width: 280px;
    background: rgba(0,0,0,0.95);
    border: 2px solid #ff0;
    border-radius: 10px;
    padding: 15px;
    color: #fff;
    font-family: monospace;
    display: none;
    z-index: 101;
    max-height: 80vh;
    overflow-y: auto;
}

.leaderboard-header {
    text-align: center;
    font-size: 18px;
    margin-bottom: 15px;
    color: #ff0;
    border-bottom: 1px solid #ff0;
    padding-bottom: 5px;
}

.leaderboard-entry {
    display: flex;
    justify-content: space-between;
    padding: 8px 5px;
    border-bottom: 1px solid #444;
    font-size: 14px;
}

.leaderboard-position {
    width: 30px;
    font-weight: bold;
    color: #ff0;
}

.leaderboard-name {
    flex: 1;
    text-align: left;
    padding: 0 10px;
}

.leaderboard-time {
    width: 90px;
    text-align: right;
    color: #0f0;
}

.leaderboard-car {
    width: 60px;
    text-align: center;
    font-size: 12px;
    color: #ccc;
}

.leaderboard-current {
    background: rgba(255,255,0,0.1);
    border-left: 3px solid #ff0;
}

.leaderboard-empty {
    text-align: center;
    padding: 20px;
    color: #888;
    font-style: italic;
}

.player-name-input {
    width: 100%;
    padding: 8px;
    margin: 10px 0;
    background: rgba(255,255,255,0.1);
    border: 1px solid #0f0;
    border-radius: 5px;
    color: #fff;
    font-family: monospace;
}

.leaderboard-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.leaderboard-actions button {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-family: monospace;
}

#saveScoreBtn {
    background: #0f0;
    color: #000;
}

#refreshLeaderboardBtn {
    background: #00f;
    color: #fff;
}

#closeLeaderboardBtn {
    background: #f00;
    color: #fff;
}

.loading-spinner {
    text-align: center;
    padding: 20px;
    color: #0ff;
}

.loading-spinner::after {
    content: ' ‚è≥';
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.success-message {
    text-align: center;
    padding: 10px;
    color: #0f0;
    background: rgba(0,255,0,0.1);
    border-radius: 5px;
    margin: 10px 0;
}

</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>

<div id="speedBarContainer"><div id="speedBar"></div></div>
<div id="debug">Cargando circuito...</div>
<div id="resetPositionBtn" title="Posici√≥n Inicial">üèÅ</div>

<!-- Indicadores en la parte inferior -->
<div id="rpmIndicator">
    <span>RPM</span>
    <div id="rpmBar"><div id="rpmFill"></div></div>
    <span id="rpmValue">0</span>
</div>
<div id="speedNumber">0 km/h</div>
<div id="gearIndicator">N</div>

<!-- Controles de cambio de marchas -->
<div id="gearControls">
    <div class="gear-btn" id="gearDown">-</div>
    <div class="gear-btn" id="gearUp">+</div>
</div>

<!-- Joystick -->
<div id="joystickContainer" class="joystick-disabled">
  <div id="joystickBase">
    <div id="joystickAxis"></div>
    <div id="joystickHandle"></div>
  </div>
</div>

<!-- Sliders tipo volumen para acelerador y freno -->
<div id="throttleSlider" class="slider" aria-label="Acelerador">
    <div id="throttleFill" class="slider-fill"></div>
    <div class="slider-label">Acel</div>
</div>
<div id="brakeSlider" class="slider" aria-label="Freno">
    <div id="brakeFill" class="slider-fill"></div>
    <div class="slider-label">Freno</div>
</div>
<div class="pedal-value" id="throttleValue">0%</div>
<div class="pedal-value brake" id="brakeValue">0%</div>

<!-- CRON√ìMETRO -->
<div id="timerPanel">
  <div id="currentTimer">00:00.000</div>
  <div id="lapTimes"></div>
  <div id="timerStatus">ESPERANDO EN META</div>
  <div id="bestLapDisplay">MEJOR VUELTA: --:--.---</div>
</div>

<!-- Botones -->
<button id="fullscreenBtn">Pantalla Completa</button>
<div id="settingsBtn">‚öôÔ∏è</div>
<div id="carsBtn">üöó</div>

<!-- Bot√≥n para clasificaci√≥n -->
<div id="leaderboardBtn" style="position:absolute;top:5px;left:150px;width:40px;height:40px;background:rgba(255,255,255,0.25);border-radius:50%;font-size:28px;text-align:center;line-height:50px;cursor:pointer;z-index:100;">üèÜ</div>

<!-- Panel de Configuraci√≥n -->
<div id="settingsPanel" class="settings-panel">
    <label>Velocidad M√°x: <span id="maxSpeedLabel">330</span> km/h</label>
    <input type="range" id="maxSpeedRange" min="50" max="500" value="330">
    
    <label>Aceleraci√≥n 0-100: <span id="accelLabel">2.0</span>s</label>
    <input type="range" id="accelRange" min="1.5" max="6.0" step="0.1" value="2.0">

    <label>Freno: <span id="brakeLabel">150</span></label>
    <input type="range" id="brakeRange" min="20" max="300" value="150">

    <label>Altura de C√°mara: <span id="cameraHeightLabel">3.0</span> m</label>
    <input type="range" id="cameraHeightRange" min="1.0" max="6.0" step="0.1" value="3.0">

    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
        <label>Sensibilidad Joystick: <span id="joystickSensitivityLabel">1.0</span></label>
        <input type="range" id="joystickSensitivityRange" min="0.1" max="3.0" step="0.1" value="1.0">
    </div>

    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
        <label style="display: flex; align-items: center; justify-content: space-between;">
            <span>Transmisi√≥n Manual</span>
            <input type="checkbox" id="manualTransmissionToggle" style="width: auto;">
        </label>
    </div>

    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
        <label style="display: flex; align-items: center; justify-content: space-between;">
            <span>Mostrar Fantasma</span>
            <input type="checkbox" id="ghostToggle" style="width: auto;" checked>
        </label>
    </div>

    <label>Clima</label>
    <select id="weatherSelect">
        <option value="sunny">Soleado</option>
        <option value="gray">Cielo Gris</option>
        <option value="sunset">Atardecer Azul</option>
    </select>
    
    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
        <label>Intensidad de Luz: <span id="lightIntensityLabel">1.2</span></label>
        <input type="range" id="lightIntensityRange" min="0.1" max="3.0" step="0.1" value="1.2" style="width:100%">
    </div>

    <label>M√∫sica</label>
    <button id="musicBtn">On</button>

    <label>N√∫mero de Vueltas</label>
    <input type="number" id="lapsNumber" min="1" max="99" value="3">
</div>

<!-- Panel de Selecci√≥n de Coches -->
<div id="carsPanel" class="settings-panel">
    <h3 style="text-align:center;margin-top:0;">SELECCIONAR COCHE</h3>
    
    <div class="car-option selected" data-car="f1">
        <strong>F√≥rmula 1</strong>
        <div class="car-stats">Vel: 350 km/h | 0-100: 1.8s | 8 Marchas | Peso: 740kg</div>
    </div>
    
    <div class="car-option" data-car="gt3">
        <strong>GT3</strong>
        <div class="car-stats">Vel: 300 km/h | 0-100: 2.5s | 6 Marchas | Peso: 1250kg</div>
    </div>
    
    <div class="car-option" data-car="gt4">
        <strong>GT4</strong>
        <div class="car-stats">Vel: 250 km/h | 0-100: 3.2s | 6 Marchas | Peso: 1350kg</div>
    </div>
    
    <div class="car-option" data-car="hypercar">
        <strong>Hypercar</strong>
        <div class="car-stats">Vel: 400 km/h | 0-100: 2.2s | 7 Marchas | Peso: 1100kg</div>
    </div>
    
    <div class="car-option" data-car="touring">
        <strong>Touring Car</strong>
        <div class="car-stats">Vel: 280 km/h | 0-100: 3.5s | 6 Marchas | Peso: 1150kg</div>
    </div>
    
    <div class="car-option" data-car="rally">
        <strong>Rally</strong>
        <div class="car-stats">Vel: 220 km/h | 0-100: 4.0s | 6 Marchas | Peso: 1300kg</div>
    </div>
    
    <div class="car-option" data-car="drift">
        <strong>Drift Car</strong>
        <div class="car-stats">Vel: 240 km/h | 0-100: 3.8s | 6 Marchas | Peso: 1200kg</div>
    </div>
</div>

<!-- PANEL DE CLASIFICACI√ìN ONLINE -->
<div id="leaderboardPanel" class="leaderboard-panel">
    <div class="leaderboard-header">üèÜ CLASIFICACI√ìN ONLINE üèÜ</div>
    
    <!-- Entrada para guardar nueva puntuaci√≥n -->
    <div id="saveScoreSection" style="display: none;">
        <h4 style="text-align:center;margin:10px 0;color:#0f0;">¬°NUEVO R√âCORD!</h4>
        <input type="text" id="playerNameInput" class="player-name-input" placeholder="Escribe tu nombre" maxlength="15">
        <div class="leaderboard-actions">
            <button id="saveScoreBtn">üíæ Guardar Online</button>
            <button id="cancelSaveBtn">‚ùå Cancelar</button>
        </div>
    </div>
    
    <!-- Lista de clasificaci√≥n -->
    <div id="leaderboardList">
        <div class="leaderboard-entry">
            <div class="leaderboard-position">#</div>
            <div class="leaderboard-name">JUGADOR</div>
            <div class="leaderboard-time">TIEMPO</div>
            <div class="leaderboard-car">COCHE</div>
        </div>
        <div id="leaderboardEntries" class="loading-spinner">
            Cargando clasificaci√≥n...
        </div>
    </div>
    
    <div class="leaderboard-actions" style="margin-top: 15px;">
        <button id="refreshLeaderboardBtn">üîÑ Actualizar</button>
        <button id="closeLeaderboardBtn">‚ùå Cerrar</button>
    </div>
    
    <div style="font-size: 10px; color: #888; text-align: center; margin-top: 10px;">
        Clasificaci√≥n guardada en la nube
    </div>
</div>

<!-- SISTEMA DE DA√ëO -->
<div id="damageIndicator">
    <div id="damageBar">
        <div id="damageFill"></div>
        <div id="damageText">DA√ëO: 0%</div>
    </div>
</div>

<div id="crashMessage">
    <h2>¬°CHOQUE!</h2>
    <p>El coche ha sufrido da√±os cr√≠ticos</p>
    <p>Volviendo a la posici√≥n inicial...</p>
</div>

<div id="screenCracks" class="damage-effect"></div>
<div id="redOverlay" class="damage-effect"></div>

<audio id="motorAudio" src="motor.mp3" loop></audio>
<audio id="crashSound" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=="></audio>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>

<script>
// =========================
// CONFIGURACI√ìN JSONBIN.IO - CON TUS DATOS
// =========================
const JSONBIN_BIN_ID = '69259cad43b1c97be9c4306b';
const JSONBIN_API_KEY = '$2a$10$e9MLZJQsvHcSL8qYL8U4nuBk8w41S89TqZvJBPkvhLJ6V52EZoi8m';
const JSONBIN_MASTER_KEY = '$2a$10$pQYPTeWLg8v5o3wkLS8I.OIHS2jZGpsanyHgS8QdUhnntNtX2e83.';

// =========================
// SISTEMA DE CLASIFICACI√ìN ONLINE
// =========================
let leaderboard = [];
let currentPlayerName = "Jugador";
let currentBestTimeForSave = 0;
let currentCarForSave = "";

// Elementos del sistema de clasificaci√≥n
const leaderboardBtn = document.getElementById("leaderboardBtn");
const leaderboardPanel = document.getElementById("leaderboardPanel");
const leaderboardEntries = document.getElementById("leaderboardEntries");
const playerNameInput = document.getElementById("playerNameInput");
const saveScoreSection = document.getElementById("saveScoreSection");
const saveScoreBtn = document.getElementById("saveScoreBtn");
const cancelSaveBtn = document.getElementById("cancelSaveBtn");
const refreshLeaderboardBtn = document.getElementById("refreshLeaderboardBtn");
const closeLeaderboardBtn = document.getElementById("closeLeaderboardBtn");

// Inicializar sistema de clasificaci√≥n
function initLeaderboardSystem() {
    loadLeaderboardFromCloud();
    setupLeaderboardEvents();
}

// Cargar clasificaci√≥n desde JSONBin.io
async function loadLeaderboardFromCloud() {
    try {
        leaderboardEntries.innerHTML = '<div class="loading-spinner">Cargando clasificaci√≥n...</div>';
        
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
            method: 'GET',
            headers: {
                'X-Master-Key': JSONBIN_API_KEY,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('Error al cargar la clasificaci√≥n');
        }
        
        const data = await response.json();
        leaderboard = data.record.leaderboard || [];
        
        updateLeaderboardDisplay();
        
    } catch (error) {
        console.error('Error cargando clasificaci√≥n:', error);
        leaderboardEntries.innerHTML = '<div class="leaderboard-empty">Error al cargar clasificaci√≥n</div>';
        showTemporaryMessage("Error cargando clasificaci√≥n", 2000);
        
        // Cargar datos locales como fallback
        const localData = localStorage.getItem('spaRacingLeaderboard');
        if (localData) {
            leaderboard = JSON.parse(localData);
            updateLeaderboardDisplay();
        }
    }
}

// Guardar clasificaci√≥n en JSONBin.io
async function saveLeaderboardToCloud() {
    try {
        // Primero guardar localmente como backup
        localStorage.setItem('spaRacingLeaderboard', JSON.stringify(leaderboard));
        
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': JSONBIN_MASTER_KEY
            },
            body: JSON.stringify({
                leaderboard: leaderboard,
                lastUpdate: new Date().toISOString(),
                totalEntries: leaderboard.length
            })
        });
        
        if (!response.ok) {
            throw new Error('Error al guardar en la nube');
        }
        
        console.log('Clasificaci√≥n guardada en la nube');
        return true;
        
    } catch (error) {
        console.error('Error guardando en la nube:', error);
        // En caso de error, al menos guardamos localmente
        localStorage.setItem('spaRacingLeaderboard', JSON.stringify(leaderboard));
        return false;
    }
}

// Configurar eventos del sistema de clasificaci√≥n
function setupLeaderboardEvents() {
    leaderboardBtn.addEventListener('click', () => {
        leaderboardPanel.style.display = 'block';
        settingsPanel.style.display = 'none';
        carsPanel.style.display = 'none';
        loadLeaderboardFromCloud();
    });
    
    saveScoreBtn.addEventListener('click', saveCurrentScoreToCloud);
    cancelSaveBtn.addEventListener('click', cancelSaveScore);
    refreshLeaderboardBtn.addEventListener('click', loadLeaderboardFromCloud);
    closeLeaderboardBtn.addEventListener('click', () => {
        leaderboardPanel.style.display = 'none';
    });
    
    playerNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            saveCurrentScoreToCloud();
        }
    });
}

// Verificar si se debe guardar una nueva puntuaci√≥n
function checkNewScore(lapTime) {
    if (lapTime <= 0) return;
    
    // Solo considerar para guardar si es una vuelta v√°lida (m√°s de 10 segundos)
    if (lapTime < 10000) return;
    
    currentBestTimeForSave = lapTime;
    currentCarForSave = currentCar;
    
    // Verificar si es un nuevo r√©cord o si hay menos de 10 puntuaciones
    if (leaderboard.length < 10 || isNewRecord(lapTime)) {
        showSaveScorePrompt();
    }
}

// Verificar si es un nuevo r√©cord
function isNewRecord(lapTime) {
    if (leaderboard.length === 0) return true;
    
    // Ordenar por tiempo (menor es mejor)
    const sortedLeaderboard = [...leaderboard].sort((a, b) => a.time - b.time);
    
    // Si hay menos de 10 entradas o el tiempo es mejor que el peor tiempo actual
    return leaderboard.length < 10 || lapTime < sortedLeaderboard[sortedLeaderboard.length - 1].time;
}

// Mostrar prompt para guardar puntuaci√≥n
function showSaveScorePrompt() {
    saveScoreSection.style.display = 'block';
    playerNameInput.value = currentPlayerName;
    playerNameInput.focus();
    leaderboardPanel.style.display = 'block';
    loadLeaderboardFromCloud();
}

// Guardar la puntuaci√≥n actual en la nube
async function saveCurrentScoreToCloud() {
    const playerName = playerNameInput.value.trim() || "Jugador";
    currentPlayerName = playerName;
    
    const newEntry = {
        name: playerName,
        time: currentBestTimeForSave,
        car: currentCarForSave,
        date: new Date().toISOString(),
        timestamp: Date.now()
    };
    
    // Agregar a la clasificaci√≥n local
    leaderboard.push(newEntry);
    
    // Ordenar y limitar a 10 entradas
    leaderboard.sort((a, b) => a.time - b.time);
    if (leaderboard.length > 10) {
        leaderboard = leaderboard.slice(0, 10);
    }
    
    // Mostrar mensaje de guardando
    saveScoreBtn.textContent = "üíæ Guardando...";
    saveScoreBtn.disabled = true;
    
    try {
        // Intentar guardar en la nube
        const success = await saveLeaderboardToCloud();
        
        if (success) {
            showTemporaryMessage("¬°Puntuaci√≥n guardada online!", 2000);
        } else {
            showTemporaryMessage("Puntuaci√≥n guardada localmente", 2000);
        }
        
        // Actualizar display
        updateLeaderboardDisplay();
        
    } catch (error) {
        showTemporaryMessage("Error guardando puntuaci√≥n", 2000);
    } finally {
        // Restaurar bot√≥n
        saveScoreBtn.textContent = "üíæ Guardar Online";
        saveScoreBtn.disabled = false;
    }
    
    // Ocultar secci√≥n de guardado
    saveScoreSection.style.display = 'none';
    leaderboardPanel.style.display = 'none';
}

// Cancelar guardado de puntuaci√≥n
function cancelSaveScore() {
    saveScoreSection.style.display = 'none';
    leaderboardPanel.style.display = 'none';
}

// Actualizar visualizaci√≥n de la clasificaci√≥n
function updateLeaderboardDisplay() {
    if (leaderboard.length === 0) {
        leaderboardEntries.innerHTML = '<div class="leaderboard-empty">No hay puntuaciones guardadas</div>';
        return;
    }
    
    // Ordenar por tiempo (menor es mejor)
    const sortedLeaderboard = [...leaderboard].sort((a, b) => a.time - b.time);
    
    let html = '';
    sortedLeaderboard.forEach((entry, index) => {
        const isCurrentPlayer = entry.name === currentPlayerName && entry.time === currentBestTimeForSave;
        const carName = getCarDisplayName(entry.car);
        
        html += `
            <div class="leaderboard-entry ${isCurrentPlayer ? 'leaderboard-current' : ''}">
                <div class="leaderboard-position">${index + 1}</div>
                <div class="leaderboard-name">${entry.name}</div>
                <div class="leaderboard-time">${formatTime(entry.time)}</div>
                <div class="leaderboard-car">${carName}</div>
            </div>
        `;
    });
    
    leaderboardEntries.innerHTML = html;
}

// Obtener nombre display del coche
function getCarDisplayName(carType) {
    const carNames = {
        'f1': 'F1',
        'gt3': 'GT3',
        'gt4': 'GT4',
        'hypercar': 'HYPER',
        'touring': 'TOUR',
        'rally': 'RALLY',
        'drift': 'DRIFT'
    };
    return carNames[carType] || carType;
}

// Mostrar mensaje temporal
function showTemporaryMessage(message, duration) {
    const messageEl = document.createElement('div');
    messageEl.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: #0f0;
        padding: 15px 30px;
        border-radius: 10px;
        border: 2px solid #0f0;
        font-family: monospace;
        font-size: 16px;
        z-index: 1000;
    `;
    messageEl.textContent = message;
    document.body.appendChild(messageEl);
    
    setTimeout(() => {
        document.body.removeChild(messageEl);
    }, duration);
}

// =========================
// SISTEMA DEL JUEGO (F√çSICA, CONTROLES, ETC.)
// =========================

// Variables del juego
let maxSpeed = 330;
let targetAccelerationTime = 2.0;
let brakeFriction = 150;
let cameraHeight = 3.0;
let currentCar = 'f1';
let currentSpeed = 0;
let throttlePressure = 0;
let brakePressure = 0;
let isManualTransmission = false;
let currentGear = 0;
let carHealth = 100;
let isCarDestroyed = false;

// Configuraci√≥n de coches
const cars = {
    'f1': { name: 'F√≥rmula 1', maxSpeed: 350, acceleration: 1.8, brake: 180, weight: 740 },
    'gt3': { name: 'GT3', maxSpeed: 300, acceleration: 2.5, brake: 160, weight: 1250 },
    'gt4': { name: 'GT4', maxSpeed: 250, acceleration: 3.2, brake: 140, weight: 1350 },
    'hypercar': { name: 'Hypercar', maxSpeed: 400, acceleration: 2.2, brake: 200, weight: 1100 },
    'touring': { name: 'Touring Car', maxSpeed: 280, acceleration: 3.5, brake: 130, weight: 1150 },
    'rally': { name: 'Rally', maxSpeed: 220, acceleration: 4.0, brake: 120, weight: 1300 },
    'drift': { name: 'Drift Car', maxSpeed: 240, acceleration: 3.8, brake: 110, weight: 1200 }
};

// Elementos UI
const settingsBtn = document.getElementById("settingsBtn");
const carsBtn = document.getElementById("carsBtn");
const settingsPanel = document.getElementById("settingsPanel");
const carsPanel = document.getElementById("carsPanel");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const resetPositionBtn = document.getElementById("resetPositionBtn");
const musicBtn = document.getElementById("musicBtn");
const motorAudio = document.getElementById("motorAudio");

// Inicializar controles
settingsBtn.addEventListener('click', () => { 
    settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
    carsPanel.style.display = 'none';
    leaderboardPanel.style.display = 'none';
});

carsBtn.addEventListener('click', () => { 
    carsPanel.style.display = carsPanel.style.display === 'none' ? 'block' : 'none';
    settingsPanel.style.display = 'none';
    leaderboardPanel.style.display = 'none';
});

fullscreenBtn.addEventListener('click', () => {
    document.documentElement.requestFullscreen?.().catch(() => {});
    fullscreenBtn.style.display = 'none';
});

resetPositionBtn.addEventListener("click", resetToStartPosition);

musicBtn.addEventListener('click', () => {
    const musicOn = musicBtn.textContent === "On";
    if (musicOn) {
        motorAudio.pause();
        musicBtn.textContent = "Off";
    } else {
        motorAudio.play().catch(e => console.log("Audio no disponible"));
        musicBtn.textContent = "On";
    }
});

// Sistema de sliders
function setupAnalogSlider(slider, fillElement, valueCallback, valueLabel) {
    let active = false;
    let touchId = null;

    slider.addEventListener('touchstart', e => {
        if (active) return;
        const touch = e.changedTouches[0];
        active = true;
        touchId = touch.identifier;
        updateSlider(touch);
    }, {passive:false});

    slider.addEventListener('touchmove', e => {
        if (!active) return;
        for (let i = 0; i < e.changedTouches.length; i++) {
            if (e.changedTouches[i].identifier === touchId) {
                updateSlider(e.changedTouches[i]);
                break;
            }
        }
    }, {passive:false});

    slider.addEventListener('touchend', e => {
        if (!active) return;
        for (let i = 0; i < e.changedTouches.length; i++) {
            if (e.changedTouches[i].identifier === touchId) {
                active = false;
                touchId = null;
                valueCallback(0);
                fillElement.style.height = '0%';
                if (valueLabel) valueLabel.textContent = '0%';
                break;
            }
        }
    });

    function updateSlider(touch) {
        const rect = slider.getBoundingClientRect();
        const relativeY = touch.clientY - rect.top;
        let pressure = 1 - (relativeY / rect.height);
        pressure = Math.max(0, Math.min(1, pressure));
        
        fillElement.style.transition = 'height 0.05s ease-out';
        fillElement.style.height = (pressure * 100) + '%';
        valueCallback(pressure);
        if (valueLabel) valueLabel.textContent = Math.round(pressure*100) + '%';
    }
}

setupAnalogSlider(document.getElementById('throttleSlider'), document.getElementById('throttleFill'), v => throttlePressure = v, document.getElementById('throttleValue'));
setupAnalogSlider(document.getElementById('brakeSlider'), document.getElementById('brakeFill'), v => brakePressure = v, document.getElementById('brakeValue'));

// Sistema de cambio de marchas
const manualTransmissionToggle = document.getElementById("manualTransmissionToggle");
const gearUpBtn = document.getElementById("gearUp");
const gearDownBtn = document.getElementById("gearDown");
const gearControls = document.getElementById("gearControls");

manualTransmissionToggle.addEventListener('change', () => {
    isManualTransmission = manualTransmissionToggle.checked;
    gearControls.style.display = isManualTransmission ? 'flex' : 'none';
    currentGear = isManualTransmission ? 1 : 0;
    updateGearIndicator();
});

gearUpBtn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (currentGear < 8) currentGear++;
    updateGearIndicator();
}, { passive: false });

gearDownBtn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (currentGear > -1) currentGear--;
    updateGearIndicator();
}, { passive: false });

function updateGearIndicator() {
    if (currentGear === 0) {
        gearIndicator.textContent = "N";
    } else if (currentGear === -1) {
        gearIndicator.textContent = "R";
    } else {
        gearIndicator.textContent = currentGear.toString();
    }
}

// Sistema de da√±os
function updateDamageUI() {
    const healthPercentage = Math.max(0, carHealth);
    document.getElementById('damageFill').style.width = `${healthPercentage}%`;
    document.getElementById('damageText').textContent = `DA√ëO: ${100 - healthPercentage}%`;
}

function applyDamage(damageAmount) {
    if (isCarDestroyed) return;
    carHealth = Math.max(0, carHealth - damageAmount);
    updateDamageUI();
    
    if (carHealth <= 0) {
        destroyCar();
    }
}

function destroyCar() {
    isCarDestroyed = true;
    document.getElementById('crashMessage').style.display = 'block';
    setTimeout(() => {
        resetAfterCrash();
    }, 3000);
}

function resetAfterCrash() {
    document.getElementById('crashMessage').style.display = 'none';
    carHealth = 100;
    isCarDestroyed = false;
    updateDamageUI();
    resetToStartPosition();
}

// Sistema de cron√≥metro
let raceStartTime = 0;
let currentLapStartTime = 0;
let bestLapTime = 0;
let lapCount = 0;
let isRacing = false;
let hasCrossedFinishLine = false;
let prevPosZ = 0;

const finishLine = { minX: -3800, maxX: -3700, z: -4025, width: 30 };

function formatTime(ms) {
    const m = Math.floor(ms / 60000);
    const s = Math.floor((ms % 60000) / 1000);
    const msr = Math.floor(ms % 1000);
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${msr.toString().padStart(3, '0')}`;
}

function updateTimerDisplay() { 
    document.getElementById('currentTimer').textContent = isRacing ? formatTime(Date.now() - currentLapStartTime) : "00:00.000"; 
    document.getElementById('bestLapDisplay').textContent = bestLapTime > 0 ? `MEJOR VUELTA: ${formatTime(bestLapTime)}` : "MEJOR VUELTA: --:--.---"; 
}

function registerCross() { 
    if (!isRacing) {
        isRacing = true; 
        raceStartTime = Date.now(); 
        currentLapStartTime = raceStartTime; 
        lapCount = 1; 
        document.getElementById('timerStatus').textContent = "VUELTA 1"; 
        document.getElementById('timerStatus').style.color = "#0f0"; 
        return;
    } 
    
    const lapTime = Date.now() - currentLapStartTime; 
    
    // Verificar si es una puntuaci√≥n para guardar
    checkNewScore(lapTime);
    
    if (bestLapTime === 0 || lapTime < bestLapTime) bestLapTime = lapTime; 
    
    const lapEl = document.createElement("div"); 
    lapEl.className = "lap-time"; 
    lapEl.textContent = `Vuelta ${lapCount}: ${formatTime(lapTime)}` + (lapTime === bestLapTime ? " ‚òÖ" : ""); 
    if (lapTime === bestLapTime) lapEl.classList.add("best-lap"); 
    document.getElementById('lapTimes').insertBefore(lapEl, document.getElementById('lapTimes').firstChild); 
    
    lapCount++; 
    currentLapStartTime = Date.now(); 
    
    if (lapCount > parseInt(document.getElementById('lapsNumber').value)) { 
        document.getElementById('timerStatus').textContent = "CARRERA COMPLETADA"; 
        isRacing = false; 
    } else { 
        document.getElementById('timerStatus').textContent = `VUELTA ${lapCount}`; 
    }
}

function checkFinishLine() { 
    const pos = playerMesh.position; 
    const insideX = (pos.x >= finishLine.minX && pos.x <= finishLine.maxX); 
    
    if (insideX) { 
        if (!hasCrossedFinishLine && prevPosZ < finishLine.z && pos.z >= finishLine.z && Math.abs(pos.z - finishLine.z) <= finishLine.width) { 
            hasCrossedFinishLine = true; 
            registerCross(); 
        } else if (!hasCrossedFinishLine && prevPosZ > finishLine.z && pos.z <= finishLine.z && Math.abs(pos.z - finishLine.z) <= finishLine.width) { 
            hasCrossedFinishLine = true; 
            registerCross(); 
        } 
    } 
    
    if (Math.abs(pos.z - finishLine.z) > finishLine.width + 10) hasCrossedFinishLine = false; 
    prevPosZ = pos.z; 
}

// BabylonJS
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);
scene.collisionsEnabled = true;

// Cielo
const skySphere = BABYLON.MeshBuilder.CreateSphere("skySphere", { diameter: 10000, segments: 64 }, scene);
const skyMaterial = new BABYLON.StandardMaterial("skyMaterial", scene);
skyMaterial.diffuseTexture = new BABYLON.Texture("https://i.ibb.co/Vc4x5sTq/cielo.jpg", scene);
skyMaterial.emissiveColor = new BABYLON.Color3(1, 1, 1);
skyMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
skyMaterial.disableLighting = true;
skyMaterial.backFaceCulling = false;
skySphere.material = skyMaterial;
skySphere.infiniteDistance = true;

// Luces
const hemiLight = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0, 1, 0), scene);
hemiLight.diffuse = new BABYLON.Color3(0.8, 0.9, 1);
hemiLight.groundColor = new BABYLON.Color3(0.2, 0.4, 0.8);
hemiLight.intensity = 1.2;

const dirLight = new BABYLON.DirectionalLight("sun", new BABYLON.Vector3(-0.5, -1, 0.5), scene);
dirLight.diffuse = new BABYLON.Color3(1, 0.95, 0.8);
dirLight.intensity = 0.8;

scene.ambientColor = new BABYLON.Color3(0.4, 0.5, 0.7);

// Jugador y c√°mara
const playerMesh = BABYLON.MeshBuilder.CreateCapsule("player", {height: 1.8, radius: 0.3}, scene);
playerMesh.isVisible = false;
playerMesh.checkCollisions = true;
playerMesh.ellipsoid = new BABYLON.Vector3(0.5, 3, 0.5);
playerMesh.ellipsoidOffset = new BABYLON.Vector3(0, 2, 0);

const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0, cameraHeight, 0), scene);
camera.parent = playerMesh;
camera.detachControl(canvas);

// Cargar circuito
BABYLON.SceneLoader.Append("", "spa.glb", scene, () => {
    scene.meshes.forEach(m => { 
        if (m !== playerMesh) m.checkCollisions = true; 
    });
    playerMesh.position.set(-3780, 330, -3980); 
    prevPosZ = playerMesh.position.z;
    camera.rotation.y = Math.PI;
    
    // Inicializar sistemas
    updateDamageUI();
    initLeaderboardSystem();
    
}, null, (s, msg) => { 
    console.error(msg); 
});

// F√≠sica del juego
const maxRealKmH = 330;
const speedFactor = maxRealKmH / maxSpeed * 1.5;
let accel = 15;
const airFriction = 8;
const maxReverse = 50;

// Bucle principal
engine.runRenderLoop(() => {
    // Clima
    switch(document.getElementById('weatherSelect').value) {
        case 'sunny': scene.clearColor = new BABYLON.Color4(0.4, 0.7, 1, 1); break;
        case 'gray': scene.clearColor = new BABYLON.Color4(0.5, 0.5, 0.5, 1); break;
        case 'sunset': scene.clearColor = new BABYLON.Color4(0.05, 0.05, 0.2, 1); break;
    }

    const dt = engine.getDeltaTime() / 1000;
    
    // F√≠sica
    let accelerationForce = accel * throttlePressure;
    let brakingForce = brakeFriction * brakePressure;

    if (isCarDestroyed) {
        accelerationForce *= 0.3;
        brakingForce *= 0.5;
    }

    if (throttlePressure > 0) {
        currentSpeed = Math.min(currentSpeed + accelerationForce * dt, maxSpeed);
    } else if (brakePressure > 0) {
        if (currentSpeed > 0) {
            currentSpeed = Math.max(currentSpeed - (brakingForce + airFriction) * dt, 0);
        } else if (currentSpeed < 0) {
            currentSpeed = Math.min(currentSpeed + (brakingForce + airFriction) * dt, 0);
        }
    } else {
        if (currentSpeed > 0) {
            currentSpeed = Math.max(currentSpeed - airFriction * dt, 0);
        } else if (currentSpeed < 0) {
            currentSpeed = Math.min(currentSpeed + airFriction * dt, 0);
        }
    }

    // Mover coche
    if (Math.abs(currentSpeed) > 0.001) { 
        const yaw = camera.rotation.y; 
        const forward = new BABYLON.Vector3(Math.sin(yaw), 0, Math.cos(yaw)); 
        playerMesh.moveWithCollisions(forward.scale(currentSpeed * speedFactor * dt)); 
    }

    // Actualizar UI
    document.getElementById('speedNumber').textContent = Math.abs(currentSpeed).toFixed(0) + ' km/h';
    document.getElementById('speedBar').style.width = (Math.min(Math.abs(currentSpeed) / maxSpeed, 1) * 100) + "%";
    
    // RPM simuladas
    const rpm = 1000 + (Math.abs(currentSpeed) / maxSpeed) * 7000;
    document.getElementById('rpmFill').style.width = Math.min(100, (rpm / 8000) * 100) + '%';
    document.getElementById('rpmValue').textContent = Math.round(rpm);

    checkFinishLine(); 
    updateTimerDisplay(); 
    
    // Mantener en el suelo
    const ray = new BABYLON.Ray(playerMesh.position.add(new BABYLON.Vector3(0, 10, 0)), new BABYLON.Vector3(0, -1, 0), 50); 
    const hit = scene.pickWithRay(ray, m => m !== playerMesh); 
    if (hit && hit.hit) playerMesh.position.y = hit.pickedPoint.y + 2; 

    scene.render();
});

window.addEventListener('resize', () => engine.resize());

// Funciones de utilidad
function resetToStartPosition() {
    currentSpeed = 0;
    playerMesh.position.set(-3780, 330, -3980);
    camera.rotation.y = 0;
    isRacing = false;
    hasCrossedFinishLine = false;
    currentLapStartTime = 0;
    raceStartTime = 0;
    lapCount = 0;
    document.getElementById('timerStatus').textContent = "ESPERANDO EN META";
    document.getElementById('timerStatus').style.color = "#0ff";
    document.getElementById('lapTimes').innerHTML = "";
    if (isCarDestroyed) {
        resetAfterCrash();
    }
}

function changeCar(carType) {
    const car = cars[carType];
    if (!car) return;
    
    currentCar = carType;
    maxSpeed = car.maxSpeed;
    targetAccelerationTime = car.acceleration;
    brakeFriction = car.brake;
    accel = 40 / targetAccelerationTime;
    
    document.querySelectorAll('.car-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`.car-option[data-car="${carType}"]`).classList.add('selected');
}

// Inicializar selecci√≥n de coches
document.querySelectorAll('.car-option').forEach(option => {
    option.addEventListener('click', () => {
        const carType = option.getAttribute('data-car');
        changeCar(carType);
        carsPanel.style.display = 'none';
    });
});

// Inicializar el juego
changeCar('f1');
</script>
</body>
</html>