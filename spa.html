<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SPA - Simulaci√≥n de Conducci√≥n Realista con Multijugador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        html, body {
            margin: 0;
            overflow: hidden;
            height: 100%;
            background: #000;
            font-family: monospace;
        }
        
        #renderCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Controles de UI */
        .button {
            position: absolute;
            bottom: 30px;
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.25);
            border-radius: 50%;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            user-select: none;
        }
        
        /* Sliders para acelerador y freno */
        .slider {
            position: absolute;
            bottom: 30px;
            width: 80px;
            height: 200px;
            background: rgba(255,255,255,0.06);
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.08);
            touch-action: none;
            z-index: 20;
            display: flex;
            align-items: flex-end;
            overflow: hidden;
        }
        
        #throttleSlider { right: 30px; }
        #brakeSlider { right: 130px; left: auto; }
        
        .slider-fill {
            width: 100%;
            height: 0%;
            background: linear-gradient(180deg, rgba(0,255,0,0.25), rgba(0,255,0,0.6));
            border-radius: 16px 16px 6px 6px;
            transition: height 0.05s;
        }
        
        #brakeFill {
            background: linear-gradient(180deg, rgba(255,0,0,0.25), rgba(255,0,0,0.6));
        }
        
        .slider-label {
            position: absolute;
            top: -22px;
            right: 0;
            font-size: 12px;
            color: #fff;
        }
        
        /* Indicadores de pedales */
        .pedal-value {
            position: absolute;
            bottom: 240px;
            right: 30px;
            color: #fff;
            font-size: 12px;
            z-index: 21;
        }
        
        .pedal-value.brake { 
            right: 130px; 
            left: auto; 
        }
        
        /* Joystick de direcci√≥n */
        #joystickContainer {
            position: absolute;
            bottom: 30px;
            left: 50px;
            width: 160px;
            height: 120px;
            pointer-events: auto;
            z-index: 10;
        }
        
        #joystickBase {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        #joystickHandle {
            position: absolute;
            width: 50px;
            height: 100px;
            background: rgba(255,255,255,0.4);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.05s;
        }
        
        #joystickAxis {
            position: absolute;
            width: 100%;
            height: 1px;
            background: rgba(255,255,255,0.2);
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }
        
        .joystick-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* Panel de cron√≥metro */
        #timerPanel {
            position: absolute;
            top: 50px;
            left: 10px;
            width: 100px;
            background: rgba(0,0,0,0.7);
            border: 2px solid #fff;
            border-radius: 10px;
            padding: 5px;
            color: #fff;
            z-index: 10;
            font-size: 12px;
        }
        
        #currentTimer {
            font-size: 18px;
            text-align: center;
            margin-bottom: 5px;
            color: #0f0;
        }
        
        #lapTimes {
            font-size: 10px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .lap-time {
            padding: 1px 0;
            border-bottom: 1px solid #444;
        }
        
        .lap-time:last-child {
            border-bottom: none;
        }
        
        .best-lap {
            color: #ff0;
            font-weight: bold;
        }
        
        #timerStatus {
            text-align: center;
            font-size: 12px;
            margin-top: 2px;
            color: #0ff;
        }
        
        #bestLapDisplay {
            text-align: center;
            font-size: 12px;
            margin-top: 2px;
            color: #ff0;
        }
        
        /* Bot√≥n pantalla completa */
        #fullscreenBtn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 25px;
            font-size: 20px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 10px;
            z-index: 100;
            cursor: pointer;
        }
        
        /* Botones de configuraci√≥n */
        #settingsBtn, #carsBtn, #multiplayerBtn, #leaderboardBtn {
            position: absolute;
            top: 5px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.25);
            border-radius: 50%;
            font-size: 28px;
            text-align: center;
            line-height: 50px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #settingsBtn { left: 100px; }
        #carsBtn { left: 50px; font-size: 30px; }
        #multiplayerBtn { right: 10px; font-size: 20px; }
        #leaderboardBtn { left: 150px; font-size: 24px; }
        
        /* Paneles de configuraci√≥n */
        .settings-panel, .leaderboard-panel {
            position: absolute;
            top: 60px;
            background: rgba(0,0,0,0.95);
            border: 2px solid #fff;
            border-radius: 10px;
            padding: 15px;
            color: #fff;
            display: none;
            z-index: 101;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #settingsPanel {
            left: 150px;
            width: 240px;
        }
        
        #carsPanel {
            left: 150px;
            width: 240px;
        }
        
        #multiplayerPanel {
            right: 10px;
            width: 200px;
        }
        
        .leaderboard-panel {
            left: 150px;
            width: 300px;
        }
        
        .settings-panel label {
            display: block;
            margin: 8px 0 4px;
            font-size: 14px;
        }
        
        .settings-panel input[type=range] {
            width: 100%;
            margin: 5px 0;
        }
        
        .settings-panel select, .settings-panel input[type=number] {
            width: 100%;
            margin-bottom: 8px;
            padding: 4px;
        }
        
        .settings-panel button {
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #fff;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Opciones de coches */
        .car-option {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .car-option:hover {
            background: rgba(255,255,255,0.2);
            border-color: #0f0;
        }
        
        .car-option.selected {
            background: rgba(0,255,0,0.2);
            border-color: #0f0;
        }
        
        .car-stats {
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }
        
        /* Bot√≥n posici√≥n inicial */
        #resetPositionBtn {
            position: absolute;
            top: 5px;
            left: 0px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.25);
            border-radius: 50%;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            cursor: pointer;
            z-index: 100;
        }
        
        /* Indicadores de velocidad y RPM */
        #gearIndicator {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 10;
            border: 1px solid #fff;
        }
        
        #speedNumber {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 18px;
            z-index: 10;
            border: 1px solid #0f0;
            font-weight: bold;
        }
        
        #rpmIndicator {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 16px;
            z-index: 10;
            border: 1px solid #0f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #rpmBar {
            width: 60px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        #rpmFill {
            height: 100%;
            width: 0%;
            background: #0f0;
            border-radius: 4px;
            transition: width 0.1s, background 0.3s;
        }
        
        /* Controles de cambio de marchas */
        #gearControls {
            position: absolute;
            bottom: 250px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 20px;
            align-items: center;
            z-index: 25;
        }
        
        .gear-btn {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border: 2px solid #fff;
            border-radius: 50%;
            color: #fff;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            z-index: 25;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            pointer-events: auto;
        }
        
        .gear-btn:active {
            background: rgba(255,255,255,0.4);
            transform: scale(0.95);
        }
        
        #gearDown {
            pointer-events: auto;
            position: absolute;
            top: 130px;
            left: 220px;
        }
        
        #gearUp {
            pointer-events: auto;
            position: absolute;
            top: 60px;
            left: 220px;
        }
        
        /* Sistema de da√±o */
        #damageIndicator {
            position: absolute;
            top: 0px;
            right: 10px;
            width: 145px;
            height: 10px;
            background: rgba(0,0,0,0.7);
            border: 1px solid #fff;
            border-radius: 10px;
            z-index: 10;
            display: flex;
            align-items: center;
            padding: 0 5px;
        }
        
        #damageBar {
            height: 70%;
            width: 100%;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        #damageFill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #0f0, #ff0, #f00);
            border-radius: 5px;
            transition: width 0.3s;
        }
        
        #damageText {
            position: absolute;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            color: #fff;
            font-weight: bold;
            text-shadow: 1px 1px 1px #000;
        }
        
        #crashMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: #f00;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 24px;
            text-align: center;
            z-index: 100;
            border: 3px solid #f00;
            display: none;
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
        }
        
        #crashMessage p {
            margin: 10px 0;
            font-size: 16px;
            color: #fff;
        }
        
        .damage-effect {
            position: absolute;
            top: 0;
            right: 10;
            width: 50%;
            height: 50%;
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        #screenCracks {
            background: radial-gradient(circle at 30% 30%, transparent 50%, rgba(255,0,0,0.1) 70%),
                        radial-gradient(circle at 70% 70%, transparent 50%, rgba(255,0,0,0.1) 70%);
        }
        
        #redOverlay {
            background: rgba(255,0,0,0.1);
        }
        
        /* Vista en primera persona del F1 */
        #f1CockpitView {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://i.ibb.co/G34CHGsk/1000024931.png');
            background-size: 120% auto;
            background-position: center 30%;
            background-repeat: no-repeat;
            z-index: 5;
            pointer-events: none;
            display: none;
            opacity: 1;
        }
        
        /* Controles de ajuste de la vista F1 */
        #cockpitControls {
            position: absolute;
            top: 100px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #0f0;
            border-radius: 5px;
            padding: 10px;
            color: #fff;
            font-family: monospace;
            font-size: 12px;
            z-index: 102;
            display: none;
        }

        .cockpit-control {
            margin: 5px 0;
        }

        .cockpit-control label {
            display: block;
            margin-bottom: 2px;
        }

        .cockpit-control input {
            width: 100%;
        }

        #cockpitAdjustBtn {
            position: absolute;
            top: 5px;
            left: 150px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.25);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 101;
        }
        
        /* Espejo retrovisor */
        #rearviewMirror {
            position: absolute;
            top: 10px;
            right: -100px;
            transform: translateX(-50%);
            width: 200px;
            height: 50px;
            background: rgba(0,0,0,0.8);
            border: 2px solid #fff;
            border-radius: 5px;
            z-index: 10;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        #rearviewCanvas {
            width: 100%;
            height: 100%;
        }

        #mirrorLabel {
            position: absolute;
            top: 2px;
            left: 5px;
            color: #fff;
            font-size: 10px;
            font-family: monospace;
            z-index: 11;
            text-shadow: 1px 1px 1px #000;
        }
        
        /* Indicador de jugadores en l√≠nea */
        #onlinePlayers {
            position: absolute;
            top: 10px;
            right: 60px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10;
            border: 1px solid #0f0;
        }
        
        /* Estilos para el sistema de clasificaci√≥n */
        .leaderboard-header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #0f0;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .leaderboard-position {
            font-weight: bold;
            width: 30px;
        }

        .leaderboard-name {
            flex-grow: 1;
            text-align: left;
            padding: 0 10px;
        }

        .leaderboard-time {
            width: 100px;
            text-align: right;
            font-family: monospace;
        }

        .leaderboard-current {
            background: rgba(0, 255, 0, 0.1);
            border-left: 3px solid #0f0;
        }

        .leaderboard-podium {
            background: rgba(255, 215, 0, 0.1);
            border-left: 3px solid #ff0;
        }

        #usernameInput {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border: 1px solid #0f0;
            border-radius: 5px;
            color: #fff;
            font-family: monospace;
        }

        #submitTimeBtn {
            width: 100%;
            padding: 10px;
            background: rgba(0,255,0,0.3);
            border: 1px solid #0f0;
            border-radius: 5px;
            color: #fff;
            font-family: monospace;
            cursor: pointer;
            margin-top: 10px;
        }

        #submitTimeBtn:hover {
            background: rgba(0,255,0,0.5);
        }

        #leaderboardMessage {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #0f0;
        }
        
        /* Ocultar elementos no necesarios */
        #speedBarContainer, #debug, #gyroIndicator, #orientationInfo, #ghostIndicator {
            display: none !important;
        }
        
        #rpmIndicator {
            background: transparent;
            border: none;
            padding: 0;
        }
        
        #rpmIndicator span {
            display: none;
        }
        
        #rpmBar {
            width: 100px;
            height: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }
        
        #rpmFill {
            height: 100%;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    
    <!-- Vista en primera persona del F1 -->
    <div id="f1CockpitView"></div>
    
    <!-- Espejo retrovisor -->
    <div id="rearviewMirror">
        <canvas id="rearviewCanvas"></canvas>
        <div id="mirrorLabel"></div>
    </div>
    
    <!-- Controles de ajuste de vista F1 -->
    <div id="cockpitControls" class="settings-panel">
        <h4 style="margin:0 0 8px 0;text-align:center;">AJUSTE VISTA F1</h4>
        <div class="cockpit-control">
            <label>Tama√±o: <span id="cockpitSizeValue">120</span>%</label>
            <input type="range" id="cockpitSizeRange" min="80" max="200" value="120">
        </div>
        <div class="cockpit-control">
            <label>Posici√≥n Vertical: <span id="cockpitPositionValue">30</span>%</label>
            <input type="range" id="cockpitPositionRange" min="-500" max="60" value="30">
        </div>
        <div class="cockpit-control">
            <label>Posici√≥n Horizontal: <span id="cockpitHorizontalValue">50</span>%</label>
            <input type="range" id="cockpitHorizontalRange" min="30" max="70" value="50">
        </div>
        <button id="closeCockpitControls">Cerrar</button>
    </div>
    
    <!-- Bot√≥n para ajustar vista F1 -->
    <div id="cockpitAdjustBtn" class="button">üîß</div>
    
    <!-- Elementos de UI -->
    <div id="speedBarContainer"><div id="speedBar"></div></div>
    <div id="debug">Cargando circuito...</div>
    <div id="resetPositionBtn" title="Posici√≥n Inicial">üèÅ</div>
    
    <!-- Indicadores en la parte inferior -->
    <div id="rpmIndicator">
        <span>RPM</span>
        <div id="rpmBar"><div id="rpmFill"></div></div>
        <span id="rpmValue">0</span>
    </div>
    <div id="speedNumber">0 km/h</div>
    <div id="gearIndicator">N</div>
    
    <!-- Controles de cambio de marchas -->
    <div id="gearControls">
        <div class="gear-btn" id="gearDown">-</div>
        <div class="gear-btn" id="gearUp">+</div>
    </div>
    
    <!-- Indicador de calibraci√≥n de giroscopio -->
    <div id="gyroIndicator">
        <div id="gyroIndicatorBar"></div>
    </div>
    
    <!-- Informaci√≥n de orientaci√≥n -->
    <div id="orientationInfo"></div>
    
    <!-- Joystick -->
    <div id="joystickContainer" class="joystick-disabled">
        <div id="joystickBase">
            <div id="joystickAxis"></div>
            <div id="joystickHandle"></div>
        </div>
    </div>
    
    <!-- Sliders para acelerador y freno -->
    <div id="throttleSlider" class="slider" aria-label="Acelerador">
        <div id="throttleFill" class="slider-fill"></div>
        <div class="slider-label">Acel</div>
    </div>
    <div id="brakeSlider" class="slider" aria-label="Freno">
        <div id="brakeFill" class="slider-fill"></div>
        <div class="slider-label">Freno</div>
    </div>
    <div class="pedal-value" id="throttleValue">0%</div>
    <div class="pedal-value brake" id="brakeValue">0%</div>
    
    <!-- Panel de cron√≥metro -->
    <div id="timerPanel">
        <div id="currentTimer">00:00.000</div>
        <div id="lapTimes"></div>
        <div id="timerStatus">ESPERANDO EN META</div>
        <div id="bestLapDisplay">MEJOR VUELTA: --:--.---</div>
    </div>
    
    <!-- Botones principales -->
    <button id="fullscreenBtn">Pantalla Completa</button>
    <div id="settingsBtn">‚öôÔ∏è</div>
    <div id="carsBtn">üöó</div>
    <div id="multiplayerBtn">üë•</div>
    <div id="leaderboardBtn">üèÜ</div>
    
    <!-- Panel de multijugador -->
    <div id="multiplayerPanel" class="settings-panel">
        <h3 style="text-align:center;margin-top:0;">MULTIJUGADOR</h3>
        
        <label style="display: flex; align-items: center; justify-content: space-between;">
            <span>Multijugador Online</span>
            <input type="checkbox" id="multiplayerToggle" style="width: auto;">
        </label>
        
        <div id="multiplayerInfo" style="font-size: 12px; color: #ccc; margin-top: 5px;">
            Conecta con otros jugadores en tiempo real
        </div>
        
        <div id="roomControls" style="margin-top: 10px; display: none;">
            <label>Sala:</label>
            <input type="text" id="roomName" value="spa-circuit" placeholder="Nombre de sala">
            <button id="joinRoomBtn" style="width:100%;margin-top:5px;">Unirse a Sala</button>
            <button id="leaveRoomBtn" style="width:100%;margin-top:5px;background:#f00;">Salir de Sala</button>
        </div>
        
        <div id="playerList" style="margin-top: 10px; max-height: 150px; overflow-y: auto;">
            <div style="font-size: 12px; color: #0f0;">Jugadores conectados:</div>
            <div id="playersContainer"></div>
        </div>
    </div>
    
    <!-- Panel de Configuraci√≥n -->
    <div id="settingsPanel" class="settings-panel">
        <label>Velocidad M√°x: <span id="maxSpeedLabel">330</span> km/h</label>
        <input type="range" id="maxSpeedRange" min="50" max="500" value="330">
        
        <label>Aceleraci√≥n 0-100: <span id="accelLabel">2.0</span>s</label>
        <input type="range" id="accelRange" min="1.5" max="6.0" step="0.1" value="2.0">

        <label>Freno: <span id="brakeLabel">150</span></label>
        <input type="range" id="brakeRange" min="20" max="300" value="150">

        <label>Altura de C√°mara: <span id="cameraHeightLabel">3.0</span> m</label>
        <input type="range" id="cameraHeightRange" min="1.0" max="6.0" step="0.1" value="3.0">

        <!-- Control de sensibilidad del joystick -->
        <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
            <label>Sensibilidad Joystick: <span id="joystickSensitivityLabel">1.0</span></label>
            <input type="range" id="joystickSensitivityRange" min="0.1" max="3.0" step="0.1" value="1.0">
            <div style="font-size: 12px; color: #ccc; margin-top: 5px;">
                Ajusta la sensibilidad del joystick de direcci√≥n
            </div>
        </div>

        <!-- Control de transmisi√≥n -->
        <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
            <label style="display: flex; align-items: center; justify-content: space-between;">
                <span>Transmisi√≥n Manual</span>
                <input type="checkbox" id="manualTransmissionToggle" style="width: auto;">
            </label>
            <div id="manualTransmissionInfo" style="font-size: 12px; color: #ccc; margin-top: 5px;">
                Activa para control manual de marchas
            </div>
        </div>

        <!-- Control de fantasma -->
        <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
            <label style="display: flex; align-items: center; justify-content: space-between;">
                <span>Mostrar Fantasma</span>
                <input type="checkbox" id="ghostToggle" style="width: auto;" checked>
            </label>
            <div style="font-size: 12px; color: #ccc; margin-top: 5px;">
                Muestra tu mejor vuelta como coche fantasma
            </div>
        </div>

        <!-- Controles para giroscopio -->
        <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
            <label style="display: flex; align-items: center; justify-content: space-between;">
                <span>Control por Giroscopio</span>
                <input type="checkbox" id="gyroToggle" style="width: auto;">
            </label>
            
            <div id="gyroControls" style="display: none;">
                <label>Sensibilidad: <span id="gyroSensitivityLabel">1.0</span></label>
                <input type="range" id="gyroSensitivityRange" min="0.1" max="8.0" step="0.1" value="1.0">
                
                <label>M√°ximo Giro: <span id="gyroMaxLabel">2.0</span></label>
                <input type="range" id="gyroMaxRange" min="0.5" max="8.0" step="0.1" value="2.0">
                
                <label>Modo de Control</label>
                <select id="gyroModeSelect">
                    <option value="beta">Inclinaci√≥n Frontal (Beta)</option>
                    <option value="gamma">Inclinaci√≥n Lateral (Gamma)</option>
                    <option value="auto">Autom√°tico (Recomendado)</option>
                </select>
                
                <button id="calibrateGyroBtn">Calibrar Giroscopio</button>
                <div style="font-size: 12px; margin-top: 5px; color: #ccc;">
                    <div>Gira el dispositivo como un volante</div>
                    <div id="gyroStatus">Estado: No disponible</div>
                    <div id="gyroDebug" style="font-size: 10px; margin-top: 3px;"></div>
                </div>
            </div>
        </div>

        <label>Clima</label>
        <select id="weatherSelect">
            <option value="sunny">Soleado</option>
            <option value="gray">Cielo Gris</option>
            <option value="sunset">Atardecer Azul</option>
        </select>
        
        <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
            <label>Intensidad de Luz: <span id="lightIntensityLabel">1.2</span></label>
            <input type="range" id="lightIntensityRange" min="0.1" max="3.0" step="0.1" value="1.2" style="width:100%">
        </div>

        <label>M√∫sica</label>
        <button id="musicBtn">On</button>

        <label>N√∫mero de Vueltas</label>
        <input type="number" id="lapsNumber" min="1" max="99" value="3">
    </div>

    <!-- Panel de Selecci√≥n de Coches -->
    <div id="carsPanel" class="settings-panel">
        <h3 style="text-align:center;margin-top:0;">SELECCIONAR COCHE</h3>
        
        <div class="car-option selected" data-car="f1">
            <strong>F√≥rmula 1</strong>
            <div class="car-stats">Vel: 350 km/h | 0-100: 1.8s | 8 Marchas | Peso: 740kg</div>
        </div>
        
        <div class="car-option" data-car="gt3">
            <strong>GT3</strong>
            <div class="car-stats">Vel: 300 km/h | 0-100: 2.5s | 6 Marchas | Peso: 1250kg</div>
        </div>
        
        <div class="car-option" data-car="gt4">
            <strong>GT4</strong>
            <div class="car-stats">Vel: 250 km/h | 0-100: 3.2s | 6 Marchas | Peso: 1350kg</div>
        </div>
        
        <div class="car-option" data-car="hypercar">
            <strong>Hypercar</strong>
            <div class="car-stats">Vel: 400 km/h | 0-100: 2.2s | 7 Marchas | Peso: 1100kg</div>
        </div>
        
        <div class="car-option" data-car="touring">
            <strong>Touring Car</strong>
            <div class="car-stats">Vel: 280 km/h | 0-100: 3.5s | 6 Marchas | Peso: 1150kg</div>
        </div>
        
        <div class="car-option" data-car="rally">
            <strong>Rally</strong>
            <div class="car-stats">Vel: 220 km/h | 0-100: 4.0s | 6 Marchas | Peso: 1300kg</div>
        </div>
        
        <div class="car-option" data-car="drift">
            <strong>Drift Car</strong>
            <div class="car-stats">Vel: 240 km/h | 0-100: 3.8s | 6 Marchas | Peso: 1200kg</div>
        </div>
    </div>

    <!-- Panel de Clasificaci√≥n -->
    <div id="leaderboardPanel" class="leaderboard-panel">
        <div class="leaderboard-header">
            <h3 style="margin:0 0 5px 0;">üèÜ CLASIFICACI√ìN üèÜ</h3>
            <div style="font-size:12px;color:#ccc;">Top 100 Mejores Tiempos</div>
        </div>
        
        <div id="leaderboardList">
            <!-- La lista se llenar√° din√°micamente -->
        </div>
        
        <div style="margin-top:15px;border-top:1px solid #444;padding-top:10px;">
            <h4 style="margin:0 0 8px 0;text-align:center;">GUARDAR TU TIEMPO</h4>
            <input type="text" id="usernameInput" placeholder="Tu nombre de usuario" maxlength="20">
            <button id="submitTimeBtn">GUARDAR TIEMPO</button>
            <div id="leaderboardMessage"></div>
        </div>
    </div>
    
    <!-- Indicador de jugadores en l√≠nea -->
    <div id="onlinePlayers">Jugadores: 1</div>

    <!-- Sistema de da√±o -->
    <div id="damageIndicator">
        <div id="damageBar">
            <div id="damageFill"></div>
            <div id="damageText">DA√ëO: 0%</div>
        </div>
    </div>

    <!-- Indicador de fantasma activo -->
    <div id="ghostIndicator">FANTASMA ACTIVO</div>

    <!-- Mensaje de choque -->
    <div id="crashMessage">
        <h2>¬°CHOQUE!</h2>
        <p>El coche ha sufrido da√±os cr√≠ticos</p>
        <p>Volviendo a la posici√≥n inicial...</p>
    </div>

    <!-- Efectos de da√±o -->
    <div id="screenCracks" class="damage-effect"></div>
    <div id="redOverlay" class="damage-effect"></div>

    <!-- Audio -->
    <audio id="motorAudio" src="motor.mp3" loop></audio>
    <audio id="crashSound" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=="></audio>

    <script>
    // =========================
    // CONFIGURACI√ìN DE FIREBASE
    // =========================
    
    // Configuraci√≥n de Firebase - REEMPLAZA CON TUS CREDENCIALES
    const firebaseConfig = {
        apiKey: "AIzaSyC4RLVq6q9v6Xq9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q",
        authDomain: "racing-a64f6.firebaseapp.com",
        databaseURL: "https://racing-a64f6-default-rtdb.firebaseio.com",
        projectId: "racing-a64f6",
        storageBucket: "racing-a64f6.appspot.com",
        messagingSenderId: "642406724818",
        appId: "1:642406724818:web:abcdef123456789"
    };

    // Inicializar Firebase
    try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase inicializado correctamente");
    } catch (error) {
        console.error("Error inicializando Firebase:", error);
    }

    const database = firebase.database();

    // =========================
    // VARIABLES GLOBALES DEL JUEGO
    // =========================
    
    // Variables de f√≠sica
    let currentSpeed = 0;
    let maxSpeed = 330;
    let maxReverse = 50;
    let airFriction = 8;
    let accel = 15;
    let brakeFriction = 150;
    let cameraHeight = 3.0;
    let currentCar = 'f1';
    
    // Variables de control
    let throttlePressure = 0;
    let brakePressure = 0;
    let isJoystickActive = false;
    let joystickRotation = 0;
    let joystickSensitivity = 1.0;
    let gyroEnabled = false;
    let gyroRotation = 0;
    
    // Variables de carrera
    let raceStartTime = 0;
    let currentLapStartTime = 0;
    let bestLapTime = 0;
    let lapCount = 0;
    let isRacing = false;
    let hasCrossedFinishLine = false;
    let prevPosZ = 0;
    let totalLaps = 3;
    
    // Variables de sistemas
    let carHealth = 100;
    let isCarDestroyed = false;
    let lastCollisionTime = 0;
    let isManualTransmission = false;
    let currentGear = 0;
    let currentRPM = 0;
    let ghostEnabled = true;
    let ghostCar = null;
    let ghostData = [];
    let isRecordingGhost = false;
    let currentBestLapGhostData = [];
    
    // Variables multijugador
    let multiplayerEnabled = false;
    let currentRoom = null;
    let playerId = null;
    let playerName = "Jugador" + Math.floor(Math.random() * 1000);
    let otherPlayers = {};
    let lastUpdateTime = 0;
    
    // =========================
    // CONFIGURACI√ìN DE BABYLON
    // =========================
    
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true);
    const scene = new BABYLON.Scene(engine);
    scene.collisionsEnabled = true;
    
    // Crear cielo
    const skySphere = BABYLON.MeshBuilder.CreateSphere("skySphere", { 
        diameter: 10000, 
        segments: 64 
    }, scene);

    const skyMaterial = new BABYLON.StandardMaterial("skyMaterial", scene);
    skyMaterial.diffuseTexture = new BABYLON.Texture("https://i.ibb.co/Vc4x5sTq/cielo.jpg", scene);
    skyMaterial.emissiveColor = new BABYLON.Color3(1, 1, 1);
    skyMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
    skyMaterial.disableLighting = true;
    skyMaterial.backFaceCulling = false;
    skySphere.material = skyMaterial;
    skySphere.infiniteDistance = true;

    // Luces
    const hemiLight = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0, 1, 0), scene);
    hemiLight.diffuse = new BABYLON.Color3(0.8, 0.9, 1);
    hemiLight.groundColor = new BABYLON.Color3(0.2, 0.4, 0.8);
    hemiLight.intensity = 1.2;

    const dirLight = new BABYLON.DirectionalLight("sun", new BABYLON.Vector3(-0.5, -1, 0.5), scene);
    dirLight.diffuse = new BABYLON.Color3(1, 0.95, 0.8);
    dirLight.intensity = 0.8;

    scene.ambientColor = new BABYLON.Color3(0.4, 0.5, 0.7);
    
    // Jugador
    const playerMesh = BABYLON.MeshBuilder.CreateCapsule("player", {height: 1.8, radius: 0.3}, scene);
    playerMesh.isVisible = false;
    playerMesh.checkCollisions = true;
    playerMesh.ellipsoid = new BABYLON.Vector3(0.5, 3, 0.5);
    playerMesh.ellipsoidOffset = new BABYLON.Vector3(0, 2, 0);

    // C√°mara
    const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0, cameraHeight, 0), scene);
    camera.parent = playerMesh;
    camera.detachControl(canvas);

    // =========================
    // SISTEMA MULTIJUGADOR
    // =========================
    
    function initMultiplayer() {
        playerId = generatePlayerId();
        
        // Event listeners para controles de multijugador
        document.getElementById("multiplayerBtn").addEventListener('click', () => {
            const panel = document.getElementById("multiplayerPanel");
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            document.getElementById("settingsPanel").style.display = 'none';
            document.getElementById("carsPanel").style.display = 'none';
            document.getElementById("leaderboardPanel").style.display = 'none';
        });
        
        document.getElementById("multiplayerToggle").addEventListener('change', (e) => {
            multiplayerEnabled = e.target.checked;
            document.getElementById("roomControls").style.display = multiplayerEnabled ? 'block' : 'none';
            
            if (multiplayerEnabled) {
                joinRoom();
            } else {
                leaveRoom();
            }
        });
        
        document.getElementById("joinRoomBtn").addEventListener('click', joinRoom);
        document.getElementById("leaveRoomBtn").addEventListener('click', leaveRoom);
        
        updateOnlinePlayersCount();
    }

    function generatePlayerId() {
        return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function joinRoom() {
        if (!multiplayerEnabled) return;
        
        currentRoom = document.getElementById("roomName").value || "spa-circuit";
        
        const playerData = {
            name: playerName,
            car: currentCar,
            position: {
                x: playerMesh.position.x,
                y: playerMesh.position.y,
                z: playerMesh.position.z
            },
            rotation: camera.rotation.y,
            speed: currentSpeed,
            timestamp: Date.now()
        };
        
        try {
            database.ref('rooms/' + currentRoom + '/players/' + playerId).set(playerData);
            
            database.ref('rooms/' + currentRoom + '/players').on('value', (snapshot) => {
                updateOtherPlayers(snapshot.val());
            });
            
            document.getElementById("multiplayerPanel").style.display = 'none';
            console.log("Conectado a la sala: " + currentRoom);
        } catch (error) {
            console.error("Error uni√©ndose a la sala:", error);
            document.getElementById("multiplayerToggle").checked = false;
            multiplayerEnabled = false;
        }
    }

    function leaveRoom() {
        if (currentRoom) {
            try {
                database.ref('rooms/' + currentRoom + '/players/' + playerId).remove();
                database.ref('rooms/' + currentRoom + '/players').off('value');
                currentRoom = null;
            } catch (error) {
                console.error("Error saliendo de la sala:", error);
            }
        }
        
        Object.values(otherPlayers).forEach(player => {
            if (player.mesh) player.mesh.dispose();
        });
        otherPlayers = {};
        
        document.getElementById("multiplayerToggle").checked = false;
        multiplayerEnabled = false;
        document.getElementById("roomControls").style.display = 'none';
        updateOnlinePlayersCount();
        
        console.log("Desconectado de la sala");
    }

    function updateOtherPlayers(playersData) {
        if (!playersData) {
            Object.values(otherPlayers).forEach(player => {
                if (player.mesh) player.mesh.dispose();
            });
            otherPlayers = {};
            updateOnlinePlayersCount();
            return;
        }
        
        Object.keys(otherPlayers).forEach(playerId => {
            if (!playersData[playerId]) {
                if (otherPlayers[playerId].mesh) {
                    otherPlayers[playerId].mesh.dispose();
                }
                delete otherPlayers[playerId];
            }
        });
        
        Object.keys(playersData).forEach(id => {
            if (id === playerId) return;
            
            const playerData = playersData[id];
            
            if (!otherPlayers[id]) {
                createOtherPlayerCar(id, playerData);
            } else {
                updateOtherPlayerCar(id, playerData);
            }
            
            otherPlayers[id] = {
                ...playerData,
                lastUpdate: Date.now()
            };
        });
        
        updateOnlinePlayersCount();
    }

    function createOtherPlayerCar(playerId, playerData) {
        const playerCar = new BABYLON.TransformNode("otherPlayer_" + playerId, scene);
        
        const mainChassis = BABYLON.MeshBuilder.CreateCylinder("otherPlayerChassis_" + playerId, {
            diameterTop: 0.8,
            diameterBottom: 1.2,
            height: 5,
            tessellation: 6
        }, scene);
        mainChassis.parent = playerCar;
        mainChassis.rotation.x = Math.PI / 2;
        
        const playerColors = [
            new BABYLON.Color3(1.0, 0.2, 0.2),
            new BABYLON.Color3(0.2, 1.0, 0.2),
            new BABYLON.Color3(0.2, 0.2, 1.0),
            new BABYLON.Color3(1.0, 1.0, 0.2),
            new BABYLON.Color3(1.0, 0.2, 1.0),
            new BABYLON.Color3(0.2, 1.0, 1.0)
        ];
        
        const colorIndex = Object.keys(otherPlayers).length % playerColors.length;
        const playerMaterial = new BABYLON.StandardMaterial("otherPlayerMaterial_" + playerId, scene);
        playerMaterial.diffuseColor = playerColors[colorIndex];
        playerMaterial.alpha = 0.8;
        playerMaterial.specularColor = new BABYLON.Color3(0.3, 0.3, 0.3);
        playerMaterial.emissiveColor = playerColors[colorIndex].scale(0.3);
        
        playerCar.getChildMeshes().forEach(mesh => {
            mesh.material = playerMaterial;
            mesh.checkCollisions = false;
            mesh.isPickable = false;
        });
        
        playerCar.position.set(
            playerData.position.x,
            playerData.position.y,
            playerData.position.z
        );
        playerCar.rotation.y = playerData.rotation;
        playerCar.scaling.set(4, 4, 4);
        
        otherPlayers[playerId] = {
            ...playerData,
            mesh: playerCar,
            lastUpdate: Date.now()
        };
        
        console.log("Nuevo jugador conectado: " + playerData.name);
    }

    function updateOtherPlayerCar(playerId, playerData) {
        const player = otherPlayers[playerId];
        if (!player || !player.mesh) return;
        
        const lerpFactor = 0.3;
        
        player.mesh.position.x = BABYLON.Scalar.Lerp(
            player.mesh.position.x,
            playerData.position.x,
            lerpFactor
        );
        
        player.mesh.position.y = BABYLON.Scalar.Lerp(
            player.mesh.position.y,
            playerData.position.y,
            lerpFactor
        );
        
        player.mesh.position.z = BABYLON.Scalar.Lerp(
            player.mesh.position.z,
            playerData.position.z,
            lerpFactor
        );
        
        player.mesh.rotation.y = BABYLON.Scalar.Lerp(
            player.mesh.rotation.y,
            playerData.rotation,
            lerpFactor
        );
        
        otherPlayers[playerId] = {
            ...playerData,
            mesh: player.mesh,
            lastUpdate: Date.now()
        };
    }

    function updateOnlinePlayersCount() {
        const count = Object.keys(otherPlayers).length + 1;
        document.getElementById("onlinePlayers").textContent = "Jugadores: " + count;
        
        const container = document.getElementById("playersContainer");
        container.innerHTML = "";
        
        const selfElement = document.createElement("div");
        selfElement.style.color = "#0f0";
        selfElement.textContent = playerName + " (T√∫)";
        container.appendChild(selfElement);
        
        Object.values(otherPlayers).forEach(player => {
            const playerElement = document.createElement("div");
            playerElement.style.color = "#ccc";
            playerElement.textContent = player.name;
            container.appendChild(playerElement);
        });
    }

    function sendPlayerData() {
        if (!multiplayerEnabled || !currentRoom) return;
        
        const currentTime = Date.now();
        if (currentTime - lastUpdateTime < 100) return;
        
        lastUpdateTime = currentTime;
        
        const playerData = {
            name: playerName,
            car: currentCar,
            position: {
                x: playerMesh.position.x,
                y: playerMesh.position.y,
                z: playerMesh.position.z
            },
            rotation: camera.rotation.y,
            speed: currentSpeed,
            timestamp: currentTime
        };
        
        try {
            database.ref('rooms/' + currentRoom + '/players/' + playerId).set(playerData);
        } catch (error) {
            console.error("Error enviando datos:", error);
        }
    }

    function cleanupInactivePlayers() {
        const currentTime = Date.now();
        const INACTIVE_THRESHOLD = 5000;
        
        Object.keys(otherPlayers).forEach(playerId => {
            const player = otherPlayers[playerId];
            if (currentTime - player.lastUpdate > INACTIVE_THRESHOLD) {
                if (player.mesh) player.mesh.dispose();
                delete otherPlayers[playerId];
                console.log("Jugador desconectado: " + player.name);
            }
        });
    }

    // =========================
    // SISTEMA DE CARRERA
    // =========================
    
    const finishLine = {
        minX: -3800,
        maxX: -3700, 
        z: -4025,
        width: 30,
        resetThresholdExtra: 10
    };

    finishLine.centerX = (finishLine.minX + finishLine.maxX) / 2;
    finishLine.resetThreshold = finishLine.width + finishLine.resetThresholdExtra;

    function formatTime(ms) {
        const m = Math.floor(ms / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        const msr = Math.floor(ms % 1000);
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${msr.toString().padStart(3, '0')}`;
    }

    function updateTimerDisplay() { 
        document.getElementById("currentTimer").textContent = isRacing ? formatTime(Date.now() - currentLapStartTime) : "00:00.000"; 
        document.getElementById("bestLapDisplay").textContent = bestLapTime > 0 ? `MEJOR VUELTA: ${formatTime(bestLapTime)}` : "MEJOR VUELTA: --:--.---"; 
    }

    function registerCross() { 
        if (!isRacing) {
            isRacing = true; 
            raceStartTime = Date.now(); 
            currentLapStartTime = raceStartTime; 
            lapCount = 1; 
            document.getElementById("timerStatus").textContent = "VUELTA 1"; 
            document.getElementById("timerStatus").style.color = "#0f0"; 
            startGhostRecording();
            return;
        } 
        
        const lapTime = Date.now() - currentLapStartTime; 
        saveGhostDataIfBestLap(lapTime);
        
        if (bestLapTime === 0 || lapTime < bestLapTime) bestLapTime = lapTime; 
        
        const lapEl = document.createElement("div"); 
        lapEl.className = "lap-time"; 
        lapEl.textContent = `Vuelta ${lapCount}: ${formatTime(lapTime)}` + (lapTime === bestLapTime ? " ‚òÖ" : ""); 
        if (lapTime === bestLapTime) lapEl.classList.add("best-lap"); 
        document.getElementById("lapTimes").insertBefore(lapEl, document.getElementById("lapTimes").firstChild); 
        
        lapCount++; 
        currentLapStartTime = Date.now(); 
        resetGhost();
        startGhostRecording();
        
        if (lapCount > totalLaps) { 
            document.getElementById("timerStatus").textContent = "CARRERA COMPLETADA"; 
            isRacing = false; 
            stopGhostRecording();
        } else { 
            document.getElementById("timerStatus").textContent = `VUELTA ${lapCount}`; 
        }
    }

    function checkFinishLine() { 
        const pos = playerMesh.position; 
        const insideX = (pos.x >= finishLine.minX && pos.x <= finishLine.maxX); 
        
        if (insideX) { 
            if (!hasCrossedFinishLine && prevPosZ < finishLine.z && pos.z >= finishLine.z && Math.abs(pos.z - finishLine.z) <= finishLine.width) { 
                hasCrossedFinishLine = true; 
                registerCross(); 
            } else if (!hasCrossedFinishLine && prevPosZ > finishLine.z && pos.z <= finishLine.z && Math.abs(pos.z - finishLine.z) <= finishLine.width) { 
                hasCrossedFinishLine = true; 
                registerCross(); 
            } 
        } 
        
        if (Math.abs(pos.z - finishLine.z) > finishLine.resetThreshold) hasCrossedFinishLine = false; 
        prevPosZ = pos.z; 
    }

    // =========================
    // SISTEMA DE FANTASMAS
    // =========================
    
    function initGhostSystem() {
        const savedGhostData = localStorage.getItem('bestLapGhostData');
        if (savedGhostData) {
            currentBestLapGhostData = JSON.parse(savedGhostData);
        }
        
        document.getElementById("ghostToggle").checked = ghostEnabled;
        document.getElementById("ghostToggle").addEventListener('change', () => {
            ghostEnabled = document.getElementById("ghostToggle").checked;
            if (!ghostEnabled && ghostCar) {
                removeGhostCar();
            }
        });
    }

    function startGhostRecording() {
        if (!ghostEnabled) return;
        isRecordingGhost = true;
        ghostData = [];
    }

    function stopGhostRecording() {
        isRecordingGhost = false;
    }

    function recordGhostData() {
        if (!isRecordingGhost || !ghostEnabled) return;
        
        const data = {
            time: Date.now() - currentLapStartTime,
            x: playerMesh.position.x,
            y: playerMesh.position.y,
            z: playerMesh.position.z,
            rotationY: camera.rotation.y,
            speed: currentSpeed
        };
        
        ghostData.push(data);
    }

    function saveGhostDataIfBestLap(lapTime) {
        if (!ghostEnabled || ghostData.length === 0) return;
        
        const currentBestTime = bestLapTime || Infinity;
        
        if (lapTime < currentBestTime) {
            currentBestLapGhostData = [...ghostData];
            localStorage.setItem('bestLapGhostData', JSON.stringify(currentBestLapGhostData));
        }
    }

    function createGhostCar() {
        if (!ghostEnabled || currentBestLapGhostData.length === 0) return;
        
        ghostCar = new BABYLON.TransformNode("ghostCar", scene);
        
        const mainChassis = BABYLON.MeshBuilder.CreateCylinder("ghostChassis", {
            diameterTop: 0.8,
            diameterBottom: 1.2,
            height: 5,
            tessellation: 6
        }, scene);
        mainChassis.parent = ghostCar;
        mainChassis.rotation.x = Math.PI / 2;
        
        const ghostMaterial = new BABYLON.StandardMaterial("ghostMaterial", scene);
        ghostMaterial.diffuseColor = new BABYLON.Color3(0.4, 0.7, 1.0);
        ghostMaterial.alpha = 0.8;
        ghostMaterial.specularColor = new BABYLON.Color3(0.3, 0.3, 0.3);
        ghostMaterial.emissiveColor = new BABYLON.Color3(0.2, 0.4, 0.6);
        
        ghostCar.getChildMeshes().forEach(mesh => {
            mesh.material = ghostMaterial;
            mesh.checkCollisions = false;
            mesh.isPickable = false;
        });
        
        ghostCar.scaling.set(4, 4, 4);
        ghostPlaybackIndex = 0;
        ghostStartTime = Date.now();
    }

    function updateGhostCar() {
        if (!ghostCar || currentBestLapGhostData.length === 0) return;
        
        const currentTime = Date.now() - ghostStartTime;
        
        while (ghostPlaybackIndex < currentBestLapGhostData.length - 1 && 
               currentBestLapGhostData[ghostPlaybackIndex + 1].time <= currentTime) {
            ghostPlaybackIndex++;
        }
        
        if (ghostPlaybackIndex < currentBestLapGhostData.length) {
            const currentFrame = currentBestLapGhostData[ghostPlaybackIndex];
            const nextFrame = currentBestLapGhostData[ghostPlaybackIndex + 1];
            
            let x, y, z, rotationY;
            if (nextFrame && currentFrame.time !== nextFrame.time) {
                const factor = (currentTime - currentFrame.time) / (nextFrame.time - currentFrame.time);
                x = currentFrame.x + (nextFrame.x - currentFrame.x) * factor;
                y = currentFrame.y + (nextFrame.y - currentFrame.y) * factor;
                z = currentFrame.z + (nextFrame.z - currentFrame.z) * factor;
                rotationY = currentFrame.rotationY + (nextFrame.rotationY - currentFrame.rotationY) * factor;
            } else {
                x = currentFrame.x;
                y = currentFrame.y;
                z = currentFrame.z;
                rotationY = currentFrame.rotationY;
            }
            
            ghostCar.position.set(x, y, z);
            ghostCar.rotation.y = rotationY;
        } else {
            removeGhostCar();
        }
    }

    function removeGhostCar() {
        if (ghostCar) {
            ghostCar.getChildMeshes().forEach(mesh => mesh.dispose());
            ghostCar.dispose();
            ghostCar = null;
        }
        ghostPlaybackIndex = 0;
    }

    function resetGhost() {
        removeGhostCar();
        if (ghostEnabled && currentBestLapGhostData.length > 0) {
            setTimeout(() => createGhostCar(), 500);
        }
    }

    // =========================
    // SISTEMA DE DA√ëO
    // =========================
    
    function initDamageSystem() {
        updateDamageUI();
    }

    function updateDamageUI() {
        const healthPercentage = Math.max(0, carHealth);
        document.getElementById("damageFill").style.width = `${healthPercentage}%`;
        document.getElementById("damageText").textContent = `DA√ëO: ${100 - healthPercentage}%`;
        
        if (healthPercentage > 70) {
            document.getElementById("damageFill").style.background = 'linear-gradient(90deg, #0f0, #0f0)';
        } else if (healthPercentage > 30) {
            document.getElementById("damageFill").style.background = 'linear-gradient(90deg, #0f0, #ff0)';
        } else {
            document.getElementById("damageFill").style.background = 'linear-gradient(90deg, #ff0, #f00)';
        }
    }

    function applyDamage(damageAmount) {
        if (isCarDestroyed) return;
        
        carHealth = Math.max(0, carHealth - damageAmount);
        updateDamageUI();
        
        showDamageEffects(damageAmount);
        
        if (carHealth <= 0) {
            destroyCar();
        }
    }

    function showDamageEffects(damageAmount) {
        document.getElementById("redOverlay").style.opacity = '0.3';
        setTimeout(() => {
            document.getElementById("redOverlay").style.opacity = '0';
        }, 200);
        
        if (damageAmount > 15) {
            document.getElementById("screenCracks").style.opacity = '0.1';
            setTimeout(() => {
                document.getElementById("screenCracks").style.opacity = '0';
            }, 1000);
        }
    }

    function destroyCar() {
        isCarDestroyed = true;
        document.getElementById("crashMessage").style.display = 'block';
        document.getElementById("screenCracks").style.opacity = '0.3';
        document.getElementById("redOverlay").style.opacity = '0.4';
        
        try {
            document.getElementById("crashSound").play();
        } catch (e) {
            console.log("Error reproduciendo sonido de choque");
        }
        
        disableCarControls();
        
        setTimeout(() => {
            resetAfterCrash();
        }, 3000);
    }

    function disableCarControls() {
        currentSpeed = currentSpeed * 0.5;
        camera.rotation.y += Math.random() * 0.1 - 0.05;
    }

    function resetAfterCrash() {
        document.getElementById("crashMessage").style.display = 'none';
        document.getElementById("screenCracks").style.opacity = '0';
        document.getElementById("redOverlay").style.opacity = '0';
        
        carHealth = 100;
        isCarDestroyed = false;
        updateDamageUI();
        resetToStartPosition();
    }

    function checkCollisions() {
        if (isCarDestroyed) return;
        
        const currentTime = Date.now();
        if (currentTime - lastCollisionTime < 1000) return;
        
        const forward = new BABYLON.Vector3(
            Math.sin(camera.rotation.y),
            0,
            Math.cos(camera.rotation.y)
        );
        
        const rayOrigin = playerMesh.position.add(new BABYLON.Vector3(0, 1, 0));
        const ray = new BABYLON.Ray(rayOrigin, forward, 5);
        const hit = scene.pickWithRay(ray, m => m !== playerMesh && m !== skySphere && m !== ghostCar);
        
        if (hit && hit.hit && hit.distance < 3) {
            const speedKmh = Math.abs(currentSpeed * 3);
            const damage = calculateCollisionDamage(speedKmh);
            
            if (damage > 0) {
                applyDamage(damage);
                lastCollisionTime = currentTime;
                currentSpeed = -currentSpeed * 0.3;
            }
        }
    }

    function calculateCollisionDamage(speedKmh) {
        if (speedKmh < 10) return 0;
        
        let damage = 0;
        
        if (speedKmh < 30) {
            damage = 5 + (speedKmh - 10) * 0.25;
        } else if (speedKmh < 60) {
            damage = 10 + (speedKmh - 30) * 0.5;
        } else if (speedKmh < 100) {
            damage = 25 + (speedKmh - 60) * 0.75;
        } else {
            damage = 55 + (speedKmh - 100) * 1.0;
        }
        
        return Math.min(damage, 50);
    }

    // =========================
    // SISTEMA DE MARCHAS
    // =========================
    
    const carGearConfigs = {
        'f1': {
            maxGear: 8,
            gearSpeedLimits: {1: 80, 2: 120, 3: 160, 4: 200, 5: 240, 6: 280, 7: 320, 8: 350},
            redlineRPM: 15000,
            maxRPM: 16000,
            idleRPM: 4000
        },
        'gt3': {
            maxGear: 6,
            gearSpeedLimits: {1: 70, 2: 110, 3: 150, 4: 190, 5: 240, 6: 300},
            redlineRPM: 8500,
            maxRPM: 9000,
            idleRPM: 800
        },
        'gt4': {
            maxGear: 6,
            gearSpeedLimits: {1: 60, 2: 90, 3: 120, 4: 160, 5: 200, 6: 250},
            redlineRPM: 7500,
            maxRPM: 8000,
            idleRPM: 700
        },
        'hypercar': {
            maxGear: 7,
            gearSpeedLimits: {1: 90, 2: 140, 3: 190, 4: 240, 5: 290, 6: 340, 7: 400},
            redlineRPM: 11000,
            maxRPM: 12000,
            idleRPM: 900
        },
        'touring': {
            maxGear: 6,
            gearSpeedLimits: {1: 60, 2: 100, 3: 140, 4: 180, 5: 220, 6: 280},
            redlineRPM: 8000,
            maxRPM: 8500,
            idleRPM: 750
        },
        'rally': {
            maxGear: 6,
            gearSpeedLimits: {1: 50, 2: 80, 3: 110, 4: 140, 5: 170, 6: 220},
            redlineRPM: 8200,
            maxRPM: 8500,
            idleRPM: 850
        },
        'drift': {
            maxGear: 6,
            gearSpeedLimits: {1: 55, 2: 85, 3: 115, 4: 145, 5: 175, 6: 240},
            redlineRPM: 7800,
            maxRPM: 8200,
            idleRPM: 800
        }
    };

    let currentGearConfig = carGearConfigs.f1;
    let maxGear = 6;

    function getCurrentGearConfig() {
        return carGearConfigs[currentCar];
    }

    function updateGearConfig() {
        currentGearConfig = getCurrentGearConfig();
        maxGear = currentGearConfig.maxGear;
        
        if (currentGear > maxGear) {
            currentGear = maxGear;
            updateGearIndicator();
        }
    }

    function updateGearIndicator() {
        if (currentGear === 0) {
            document.getElementById("gearIndicator").textContent = "N";
        } else if (currentGear === -1) {
            document.getElementById("gearIndicator").textContent = "R";
        } else {
            document.getElementById("gearIndicator").textContent = currentGear.toString();
        }
    }

    function calculateRPM(speedKmh, gear) {
        if (gear <= 0) return currentGearConfig.idleRPM;
        
        const config = getCurrentGearConfig();
        const speedMs = speedKmh / 3.6;
        const wheelRPM = (speedMs * 60) / (2 * Math.PI * 0.33);
        const engineRPM = wheelRPM * 3.8 * 3.8;
        
        return Math.max(config.idleRPM, Math.min(config.maxRPM, engineRPM));
    }

    function updateRPMIndicator(rpm) {
        const config = getCurrentGearConfig();
        const rpmPercentage = (rpm - config.idleRPM) / (config.redlineRPM - config.idleRPM) * 100;
        document.getElementById("rpmFill").style.width = Math.min(100, rpmPercentage) + '%';
        document.getElementById("rpmValue").textContent = Math.round(rpm);
        
        if (rpmPercentage < 60) {
            document.getElementById("rpmFill").style.background = '#0f0';
        } else if (rpmPercentage < 85) {
            document.getElementById("rpmFill").style.background = '#ff0';
        } else {
            document.getElementById("rpmFill").style.background = '#f00';
        }
    }

    // =========================
    // BASE DE DATOS DE COCHES
    // =========================
    
    const cars = {
        'f1': { 
            name: 'F√≥rmula 1', 
            maxSpeed: 350, 
            acceleration: 1.8, 
            brake: 180,
            weight: 740
        },
        'gt3': { 
            name: 'GT3', 
            maxSpeed: 300, 
            acceleration: 2.5, 
            brake: 160,
            weight: 1250
        },
        'gt4': { 
            name: 'GT4', 
            maxSpeed: 250, 
            acceleration: 3.2, 
            brake: 140,
            weight: 1350
        },
        'hypercar': { 
            name: 'Hypercar', 
            maxSpeed: 400, 
            acceleration: 2.2, 
            brake: 200,
            weight: 1100
        },
        'touring': { 
            name: 'Touring Car', 
            maxSpeed: 280, 
            acceleration: 3.5, 
            brake: 130,
            weight: 1150
        },
        'rally': { 
            name: 'Rally', 
            maxSpeed: 220, 
            acceleration: 4.0, 
            brake: 120,
            weight: 1300
        },
        'drift': { 
            name: 'Drift Car', 
            maxSpeed: 240, 
            acceleration: 3.8, 
            brake: 110,
            weight: 1200
        }
    };

    function changeCar(carType) {
        const car = cars[carType];
        if (!car) return;
        
        currentCar = carType;
        maxSpeed = car.maxSpeed;
        accel = calculateAccelerationFromTime(car.acceleration);
        brakeFriction = car.brake;
        
        updateGearConfig();
        
        document.getElementById("maxSpeedRange").value = maxSpeed;
        document.getElementById("maxSpeedLabel").textContent = maxSpeed;
        
        document.getElementById("accelRange").value = car.acceleration;
        document.getElementById("accelLabel").textContent = car.acceleration.toFixed(1);
        
        document.getElementById("brakeRange").value = brakeFriction;
        document.getElementById("brakeLabel").textContent = brakeFriction;
        
        document.querySelectorAll('.car-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.querySelector(`.car-option[data-car="${carType}"]`).classList.add('selected');
        
        updateCockpitView();
    }

    function calculateAccelerationFromTime(zeroTo100Time) {
        const targetSpeedMs = 27.78;
        return (targetSpeedMs / zeroTo100Time) * 3;
    }

    // =========================
    // CONTROLES DE UI
    // =========================
    
    function setupAnalogSlider(slider, fillElement, valueCallback, valueLabel) {
        let active = false;
        let touchId = null;

        slider.addEventListener('touchstart', e => {
            if (active) return;
            
            const touch = e.changedTouches[0];
            active = true;
            touchId = touch.identifier;
            updateSlider(touch);
        }, {passive:false});

        slider.addEventListener('touchmove', e => {
            if (!active) return;
            
            for (let i = 0; i < e.changedTouches.length; i++) {
                if (e.changedTouches[i].identifier === touchId) {
                    updateSlider(e.changedTouches[i]);
                    break;
                }
            }
        }, {passive:false});

        slider.addEventListener('touchend', e => {
            if (!active) return;
            
            for (let i = 0; i < e.changedTouches.length; i++) {
                if (e.changedTouches[i].identifier === touchId) {
                    active = false;
                    touchId = null;
                    valueCallback(0);
                    fillElement.style.height = '0%';
                    if (valueLabel) valueLabel.textContent = '0%';
                    break;
                }
            }
        });

        slider.addEventListener('touchcancel', e => {
            if (!active) return;
            
            for (let i = 0; i < e.changedTouches.length; i++) {
                if (e.changedTouches[i].identifier === touchId) {
                    active = false;
                    touchId = null;
                    valueCallback(0);
                    fillElement.style.height = '0%';
                    if (valueLabel) valueLabel.textContent = '0%';
                    break;
                }
            }
        });

        function updateSlider(touch) {
            const rect = slider.getBoundingClientRect();
            const relativeY = touch.clientY - rect.top;
            let pressure = 1 - (relativeY / rect.height);
            pressure = Math.max(0, Math.min(1, pressure));
            
            fillElement.style.transition = 'height 0.05s ease-out';
            fillElement.style.height = (pressure * 100) + '%';
            valueCallback(pressure);
            if (valueLabel) valueLabel.textContent = Math.round(pressure*100) + '%';
        }
    }

    // =========================
    // JOYSTICK
    // =========================
    
    function updateJoystick(touch) { 
        const rect = document.getElementById("joystickContainer").getBoundingClientRect(); 
        const dx = touch.clientX - (rect.left + rect.width / 2); 
        const maxDist = rect.width / 2 - document.getElementById("joystickHandle").offsetWidth / 2; 
        const dist = Math.min(Math.abs(dx), maxDist); 
        document.getElementById("joystickHandle").style.transform = `translate(calc(-50% + ${Math.sign(dx) * dist}px), -50%)`; 
        joystickRotation = Math.max(-1, Math.min(1, dx / maxDist)); 
    }

    function resetJoystick() { 
        document.getElementById("joystickHandle").style.transform = 'translate(-50%, -50%)'; 
        joystickRotation = 0; 
    }

    function updateJoystickState() { 
        if (Math.abs(currentSpeed) >= 5) {
            document.getElementById("joystickContainer").classList.remove('joystick-disabled'); 
        } else { 
            document.getElementById("joystickContainer").classList.add('joystick-disabled'); 
            if (isJoystickActive) { 
                resetJoystick(); 
                isJoystickActive = false; 
            }
        }
    }

    // =========================
    // VISTA EN PRIMERA PERSONA
    // =========================
    
    let cockpitSize = 120;
    let cockpitPosition = 30;
    let cockpitHorizontal = 50;

    function updateCockpitView() {
        if (currentCar === 'f1') {
            document.getElementById("f1CockpitView").style.display = 'block';
            document.getElementById("f1CockpitView").style.backgroundImage = 'url("https://i.ibb.co/0y3Sdx2v/1000024931-1.png")';
            document.getElementById("f1CockpitView").style.backgroundSize = cockpitSize + '% auto';
            document.getElementById("f1CockpitView").style.backgroundPosition = cockpitHorizontal + '% ' + cockpitPosition + '%';
            document.getElementById("cockpitAdjustBtn").style.display = 'flex';
        } else if (currentCar === 'gt3') {
            document.getElementById("f1CockpitView").style.display = 'block';
            document.getElementById("f1CockpitView").style.backgroundImage = 'url("https://i.ibb.co/vv36qFqn/1000024943.png")';
            document.getElementById("f1CockpitView").style.backgroundSize = cockpitSize + '% auto';
            document.getElementById("f1CockpitView").style.backgroundPosition = cockpitHorizontal + '% ' + cockpitPosition + '%';
            document.getElementById("cockpitAdjustBtn").style.display = 'flex';
        } else {
            document.getElementById("f1CockpitView").style.display = 'block';
            document.getElementById("f1CockpitView").style.backgroundImage = 'url("https://i.ibb.co/G34CHGsk/1000024931.png")';
            document.getElementById("f1CockpitView").style.backgroundSize = cockpitSize + '% auto';
            document.getElementById("f1CockpitView").style.backgroundPosition = cockpitHorizontal + '% ' + cockpitPosition + '%';
            document.getElementById("cockpitAdjustBtn").style.display = 'flex';
        }
    }

    // =========================
    // ESPEJO RETROVISOR
    // =========================
    
    const rearviewCanvas = document.getElementById("rearviewCanvas");
    const rearviewEngine = new BABYLON.Engine(rearviewCanvas, true);
    const rearviewScene = new BABYLON.Scene(rearviewEngine);
    let rearviewCamera = null;

    function initRearviewMirror() {
        rearviewCamera = new BABYLON.FreeCamera("rearviewCam", new BABYLON.Vector3(0, cameraHeight, 0), rearviewScene);
        rearviewCamera.parent = playerMesh;
        rearviewCamera.detachControl(rearviewCanvas);
        rearviewCamera.rotation.y = Math.PI;
        rearviewCamera.fov = 1.2;

        const mirrorSkySphere = BABYLON.MeshBuilder.CreateSphere("mirrorSkySphere", { 
            diameter: 10000, 
            segments: 64 
        }, rearviewScene);

        const mirrorSkyMaterial = new BABYLON.StandardMaterial("mirrorSkyMaterial", rearviewScene);
        mirrorSkyMaterial.diffuseTexture = new BABYLON.Texture("https://i.ibb.co/Vc4x5sTq/cielo.jpg", rearviewScene);
        mirrorSkyMaterial.emissiveColor = new BABYLON.Color3(1, 1, 1);
        mirrorSkyMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
        mirrorSkyMaterial.disableLighting = true;
        mirrorSkyMaterial.backFaceCulling = false;
        mirrorSkySphere.material = mirrorSkyMaterial;
        mirrorSkySphere.infiniteDistance = true;

        const mirrorHemiLight = new BABYLON.HemisphericLight("mirrorHemi", new BABYLON.Vector3(0, 1, 0), rearviewScene);
        mirrorHemiLight.diffuse = new BABYLON.Color3(0.8, 0.9, 1);
        mirrorHemiLight.groundColor = new BABYLON.Color3(0.2, 0.4, 0.8);
        mirrorHemiLight.intensity = 1.2;

        const mirrorDirLight = new BABYLON.DirectionalLight("mirrorSun", new BABYLON.Vector3(-0.5, -1, 0.5), rearviewScene);
        mirrorDirLight.diffuse = new BABYLON.Color3(1, 0.95, 0.8);
        mirrorDirLight.intensity = 0.8;

        rearviewScene.ambientColor = new BABYLON.Color3(0.4, 0.5, 0.7);
        
        BABYLON.SceneLoader.Append("", "spa.glb", rearviewScene, () => {
            rearviewScene.meshes.forEach(m => { 
                if (m !== mirrorSkySphere) m.checkCollisions = true; 
            });
        }, null, (s, msg) => { 
            console.error("Error cargando circuito en espejo:", msg); 
        });
        
        rearviewEngine.runRenderLoop(() => {
            if (camera && rearviewCamera) {
                rearviewCamera.position.copyFrom(camera.position);
                rearviewCamera.rotation.y = camera.rotation.y + Math.PI;
            }
            
            switch(document.getElementById("weatherSelect").value) {
                case 'sunny': 
                    rearviewScene.clearColor = new BABYLON.Color4(0.4, 0.7, 1, 1); 
                    break;
                case 'gray': 
                    rearviewScene.clearColor = new BABYLON.Color4(0.5, 0.5, 0.5, 1); 
                    break;
                case 'sunset': 
                    rearviewScene.clearColor = new BABYLON.Color4(0.05, 0.05, 0.2, 1); 
                    break;
            }
            
            rearviewScene.render();
        });
        
        window.addEventListener('resize', () => rearviewEngine.resize());
    }

    // =========================
    // SISTEMA DE CLASIFICACI√ìN
    // =========================
    
    const BIN_ID = "69259cad43b1c97be9c4306b";
    const MASTER_KEY = "$2a$10$e9MLZJQsvHcSL8qYL8U4nuBk8w41S89TqZvJBPkvhLJ6V52EZoi8m";
    const ACCESS_KEY_VALUE = "$2a$10$pQYPTeWLg8v5o3wkLS8I.OIHS2jZGpsanyHgS8QdUhnntNtX2e83";

    let leaderboardData = [];
    let currentUsername = "";

    function initLeaderboardSystem() {
        document.getElementById("leaderboardBtn").addEventListener('click', () => {
            const panel = document.getElementById("leaderboardPanel");
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            document.getElementById("settingsPanel").style.display = 'none';
            document.getElementById("carsPanel").style.display = 'none';
            document.getElementById("multiplayerPanel").style.display = 'none';
            
            if (panel.style.display === 'block') {
                loadLeaderboard();
            }
        });
        
        document.getElementById("submitTimeBtn").addEventListener('click', submitBestTime);
        loadLeaderboard();
    }

    async function loadLeaderboard() {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                headers: {
                    'X-Master-Key': MASTER_KEY,
                    'X-Access-Key': ACCESS_KEY_VALUE
                }
            });
            
            if (!response.ok) {
                throw new Error('Error al cargar la clasificaci√≥n');
            }
            
            const data = await response.json();
            leaderboardData = data.record.leaderboard || [];
            leaderboardData.sort((a, b) => a.time - b.time);
            updateLeaderboardDisplay();
        } catch (error) {
            console.error('Error cargando clasificaci√≥n:', error);
            document.getElementById("leaderboardList").innerHTML = '<div style="text-align:center;color:#f00;">Error cargando clasificaci√≥n</div>';
        }
    }

    function updateLeaderboardDisplay() {
        if (leaderboardData.length === 0) {
            document.getElementById("leaderboardList").innerHTML = '<div style="text-align:center;color:#ccc;">No hay tiempos registrados a√∫n</div>';
            return;
        }
        
        let html = '';
        const maxEntries = 100;
        
        leaderboardData.slice(0, maxEntries).forEach((entry, index) => {
            const position = index + 1;
            const isCurrentUser = entry.username === currentUsername && entry.time === bestLapTime;
            const isPodium = position <= 3;
            
            let entryClass = '';
            if (isCurrentUser) entryClass = 'leaderboard-current';
            if (isPodium) entryClass = 'leaderboard-podium';
            
            html += `
                <div class="leaderboard-entry ${entryClass}">
                    <div class="leaderboard-position">${position}.</div>
                    <div class="leaderboard-name">${entry.username}</div>
                    <div class="leaderboard-time">${formatTime(entry.time)}</div>
                </div>
            `;
        });
        
        document.getElementById("leaderboardList").innerHTML = html;
    }

    async function submitBestTime() {
        if (!bestLapTime || bestLapTime === 0) {
            document.getElementById("leaderboardMessage").textContent = "No tienes un mejor tiempo registrado";
            document.getElementById("leaderboardMessage").style.color = "#f00";
            return;
        }
        
        const username = document.getElementById("usernameInput").value.trim();
        if (!username) {
            document.getElementById("leaderboardMessage").textContent = "Por favor, ingresa un nombre de usuario";
            document.getElementById("leaderboardMessage").style.color = "#f00";
            return;
        }
        
        if (username.length > 20) {
            document.getElementById("leaderboardMessage").textContent = "El nombre debe tener m√°ximo 20 caracteres";
            document.getElementById("leaderboardMessage").style.color = "#f00";
            return;
        }
        
        currentUsername = username;
        
        const existingEntryIndex = leaderboardData.findIndex(entry => 
            entry.username.toLowerCase() === username.toLowerCase()
        );
        
        if (existingEntryIndex !== -1) {
            if (bestLapTime < leaderboardData[existingEntryIndex].time) {
                leaderboardData[existingEntryIndex].time = bestLapTime;
                leaderboardData[existingEntryIndex].date = new Date().toISOString();
            } else {
                document.getElementById("leaderboardMessage").textContent = "Ya tienes un tiempo mejor registrado";
                document.getElementById("leaderboardMessage").style.color = "#ff0";
                updateLeaderboardDisplay();
                return;
            }
        } else {
            leaderboardData.push({
                username: username,
                time: bestLapTime,
                date: new Date().toISOString(),
                car: currentCar
            });
        }
        
        leaderboardData.sort((a, b) => a.time - b.time);
        
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': MASTER_KEY,
                    'X-Access-Key': ACCESS_KEY_VALUE
                },
                body: JSON.stringify({
                    leaderboard: leaderboardData
                })
            });
            
            if (!response.ok) {
                throw new Error('Error al guardar el tiempo');
            }
            
            document.getElementById("leaderboardMessage").textContent = "¬°Tiempo guardado exitosamente!";
            document.getElementById("leaderboardMessage").style.color = "#0f0";
            updateLeaderboardDisplay();
            document.getElementById("usernameInput").value = "";
            
        } catch (error) {
            console.error('Error guardando tiempo:', error);
            document.getElementById("leaderboardMessage").textContent = "Error al guardar el tiempo";
            document.getElementById("leaderboardMessage").style.color = "#f00";
        }
    }

    // =========================
    // FUNCIONES DE UTILIDAD
    // =========================
    
    function keepGround() { 
        const ray = new BABYLON.Ray(
            playerMesh.position.add(new BABYLON.Vector3(0, 10, 0)), 
            new BABYLON.Vector3(0, -1, 0), 
            50
        ); 
        const hit = scene.pickWithRay(ray, m => m !== playerMesh && m !== ghostCar); 
        if (hit && hit.hit) playerMesh.position.y = hit.pickedPoint.y + 2; 
    }

    function resetToStartPosition() {
        currentSpeed = 0;
        playerMesh.position.set(-3780, 330, -3980);
        camera.rotation.y = 0;
        
        isRacing = false;
        hasCrossedFinishLine = false;
        currentLapStartTime = 0;
        raceStartTime = 0;
        lapCount = 0;
        document.getElementById("timerStatus").textContent = "ESPERANDO EN META";
        document.getElementById("timerStatus").style.color = "#0ff";
        document.getElementById("lapTimes").innerHTML = "";
        
        stopGhostRecording();
        removeGhostCar();
        
        if (isCarDestroyed) {
            resetAfterCrash();
        }
    }

    // =========================
    // INICIALIZACI√ìN
    // =========================
    
    // Cargar circuito
    BABYLON.SceneLoader.Append("", "spa.glb", scene, () => {
        scene.meshes.forEach(m => { 
            if (m !== playerMesh && m !== ghostCar) m.checkCollisions = true; 
        });
        playerMesh.position.set(-3780, 330, -3980); 
        prevPosZ = playerMesh.position.z;
        camera.rotation.y = Math.PI;
        
        // Inicializar sistemas
        initDamageSystem();
        initGhostSystem();
        initMultiplayer();
        initLeaderboardSystem();
        updateCockpitView();
        initRearviewMirror();
        
    }, null, (s, msg) => { 
        console.error(msg); 
    });

    // Configurar controles
    setupAnalogSlider(
        document.getElementById('throttleSlider'), 
        document.getElementById('throttleFill'), 
        v => throttlePressure = v, 
        document.getElementById('throttleValue')
    );
    
    setupAnalogSlider(
        document.getElementById('brakeSlider'), 
        document.getElementById('brakeFill'), 
        v => brakePressure = v, 
        document.getElementById('brakeValue')
    );

    // Event listeners para joystick
    document.getElementById("joystickContainer").addEventListener('touchstart', e => { 
        if (Math.abs(currentSpeed) < 5) return; 
        e.preventDefault(); 
        isJoystickActive = true; 
        updateJoystick(e.touches[0]); 
    });

    document.getElementById("joystickContainer").addEventListener('touchmove', e => { 
        if (Math.abs(currentSpeed) < 5) { 
            resetJoystick(); 
            return; 
        } 
        if (!isJoystickActive) return; 
        e.preventDefault(); 
        updateJoystick(e.touches[0]); 
    });

    document.getElementById("joystickContainer").addEventListener('touchend', e => { 
        e.preventDefault(); 
        isJoystickActive = false; 
        resetJoystick(); 
    });

    // Botones de UI
    document.getElementById("fullscreenBtn").addEventListener('click', () => {
        document.documentElement.requestFullscreen?.().catch(() => {});
        if (screen.orientation && screen.orientation.lock) screen.orientation.lock("landscape").catch(() => {});
        document.getElementById("fullscreenBtn").style.display = 'none';
    });

    document.getElementById("settingsBtn").addEventListener('click', () => { 
        document.getElementById("settingsPanel").style.display = document.getElementById("settingsPanel").style.display === 'none' ? 'block' : 'none';
        document.getElementById("carsPanel").style.display = 'none';
        document.getElementById("multiplayerPanel").style.display = 'none';
        document.getElementById("leaderboardPanel").style.display = 'none';
    });

    document.getElementById("carsBtn").addEventListener('click', () => { 
        document.getElementById("carsPanel").style.display = document.getElementById("carsPanel").style.display === 'none' ? 'block' : 'none';
        document.getElementById("settingsPanel").style.display = 'none';
        document.getElementById("multiplayerPanel").style.display = 'none';
        document.getElementById("leaderboardPanel").style.display = 'none';
    });

    document.getElementById("resetPositionBtn").addEventListener("click", resetToStartPosition);

    // Selecci√≥n de coches
    document.querySelectorAll('.car-option').forEach(option => {
        option.addEventListener('click', () => {
            const carType = option.getAttribute('data-car');
            changeCar(carType);
            document.getElementById("carsPanel").style.display = 'none';
        });
    });

    // Controles de configuraci√≥n
    document.getElementById("maxSpeedRange").addEventListener('input', () => { 
        maxSpeed = parseInt(document.getElementById("maxSpeedRange").value); 
        document.getElementById("maxSpeedLabel").textContent = maxSpeed; 
    });

    document.getElementById("accelRange").addEventListener('input', () => { 
        const targetAccelerationTime = parseFloat(document.getElementById("accelRange").value);
        accel = calculateAccelerationFromTime(targetAccelerationTime);
        document.getElementById("accelLabel").textContent = targetAccelerationTime.toFixed(1);
    });

    document.getElementById("brakeRange").addEventListener('input', () => { 
        brakeFriction = parseInt(document.getElementById("brakeRange").value); 
        document.getElementById("brakeLabel").textContent = brakeFriction; 
    });

    document.getElementById("cameraHeightRange").addEventListener('input', () => { 
        cameraHeight = parseFloat(document.getElementById("cameraHeightRange").value);
        document.getElementById("cameraHeightLabel").textContent = cameraHeight.toFixed(1);
        if (camera) {
            camera.position.y = cameraHeight;
        }
    });

    document.getElementById("manualTransmissionToggle").addEventListener('change', () => {
        isManualTransmission = document.getElementById("manualTransmissionToggle").checked;
        document.getElementById("gearControls").style.display = isManualTransmission ? 'flex' : 'none';
        
        if (isManualTransmission) {
            currentGear = 1;
            updateGearIndicator();
        } else {
            currentGear = 0;
            updateGearIndicator();
        }
    });

    // Botones de cambio de marchas
    document.getElementById("gearUp").addEventListener('touchstart', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const currentSpeedKmh = Math.abs(currentSpeed * 3);
        
        if (currentGear === -1) {
            currentGear = 0;
            updateGearIndicator();
        } else if (currentGear === 0) {
            currentGear = 1;
            updateGearIndicator();
        } else if (currentGear < maxGear && currentGear > 0) {
            currentGear++;
            updateGearIndicator();
        }
        
        document.getElementById("gearUp").style.transform = 'scale(0.95)';
        setTimeout(() => { document.getElementById("gearUp").style.transform = 'scale(1)'; }, 100);
    }, { passive: false });

    document.getElementById("gearDown").addEventListener('touchstart', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const currentSpeedKmh = Math.abs(currentSpeed * 3);
        
        if (currentGear > 1) {
            currentGear--;
            updateGearIndicator();
        } else if (currentGear === 1) {
            currentGear = 0;
            updateGearIndicator();
        } else if (currentGear === 0) {
            if (currentSpeedKmh < 5) {
                currentGear = -1;
                updateGearIndicator();
            }
        }
        
        document.getElementById("gearDown").style.transform = 'scale(0.95)';
        setTimeout(() => { document.getElementById("gearDown").style.transform = 'scale(1)'; }, 100);
    }, { passive: false });

    // Controles de vista F1
    document.getElementById("cockpitSizeRange").addEventListener('input', function() {
        cockpitSize = parseInt(this.value);
        document.getElementById("cockpitSizeValue").textContent = cockpitSize;
        updateCockpitView();
    });

    document.getElementById("cockpitPositionRange").addEventListener('input', function() {
        cockpitPosition = parseInt(this.value);
        document.getElementById("cockpitPositionValue").textContent = cockpitPosition;
        updateCockpitView();
    });

    document.getElementById("cockpitHorizontalRange").addEventListener('input', function() {
        cockpitHorizontal = parseInt(this.value);
        document.getElementById("cockpitHorizontalValue").textContent = cockpitHorizontal;
        updateCockpitView();
    });

    document.getElementById("closeCockpitControls").addEventListener('click', function() {
        document.getElementById("cockpitControls").style.display = 'none';
    });

    document.getElementById("cockpitAdjustBtn").addEventListener('click', function() {
        document.getElementById("cockpitControls").style.display = document.getElementById("cockpitControls").style.display === 'none' ? 'block' : 'none';
    });

    // =========================
    // BUCLE PRINCIPAL
    // =========================
    
    const speedFactor = 3;
    const rotationSpeed = 1.2;

    engine.runRenderLoop(() => {
        // Clima
        switch(document.getElementById("weatherSelect").value) {
            case 'sunny': 
                scene.clearColor = new BABYLON.Color4(0.4, 0.7, 1, 1); 
                break;
            case 'gray': 
                scene.clearColor = new BABYLON.Color4(0.5, 0.5, 0.5, 1); 
                break;
            case 'sunset': 
                scene.clearColor = new BABYLON.Color4(0.05, 0.05, 0.2, 1); 
                break;
        }

        const dt = engine.getDeltaTime() / 1000;
        
        // Sincronizar vista F1
        if (currentCar === 'f1' && document.getElementById("f1CockpitView").style.display !== 'none') {
            const rotation = camera.rotation.y;
            const maxRotation = 20;
            const offsetX = Math.sin(rotation) * maxRotation;
            const tilt = Math.sin(rotation) * 2;
            document.getElementById("f1CockpitView").style.transform = `translateX(${offsetX}px) rotate(${tilt}deg)`;
        }
        
        // Calcular RPM
        const currentSpeedKmh = Math.abs(currentSpeed * speedFactor);
        currentRPM = calculateRPM(currentSpeedKmh, currentGear);
        updateRPMIndicator(currentRPM);
        
        // F√≠sica del coche
        let accelerationForce = accel * throttlePressure;
        let brakingForce = brakeFriction * brakePressure;

        if (isCarDestroyed) {
            accelerationForce *= 0.3;
            brakingForce *= 0.5;
            camera.rotation.y += (Math.random() * 0.1 - 0.05) * dt * 10;
        }

        // Movimiento
        if (throttlePressure > 0) {
            if (isManualTransmission) {
                if (currentGear === 0) {
                    if (currentSpeed > 0) {
                        currentSpeed = Math.max(currentSpeed - (airFriction * 2) * dt, 0);
                    } else if (currentSpeed < 0) {
                        currentSpeed = Math.min(currentSpeed + (airFriction * 2) * dt, 0);
                    }
                } else if (currentGear > 0) {
                    currentSpeed = Math.min(currentSpeed + accelerationForce * dt, maxSpeed);
                } else if (currentGear === -1) {
                    currentSpeed = Math.max(currentSpeed - accelerationForce * dt, -maxReverse);
                }
            } else {
                currentSpeed = Math.min(currentSpeed + accelerationForce * dt, maxSpeed);
            }
        } else if (brakePressure > 0) {
            if (currentSpeed > 0) {
                currentSpeed = Math.max(currentSpeed - (brakingForce + airFriction) * dt, 0);
            } else if (currentSpeed < 0) {
                currentSpeed = Math.min(currentSpeed + (brakingForce + airFriction) * dt, 0);
            }
        } else {
            if (currentSpeed > 0) {
                currentSpeed = Math.max(currentSpeed - airFriction * dt, 0);
            } else if (currentSpeed < 0) {
                currentSpeed = Math.min(currentSpeed + airFriction * dt, 0);
            }
        }

        updateJoystickState();
        
        // Control de direcci√≥n
        let steeringRotation = 0;
        if (gyroEnabled && Math.abs(currentSpeed) >= 5) {
            steeringRotation = gyroRotation * rotationSpeed * dt;
        } else if (isJoystickActive && Math.abs(joystickRotation) > 0.1 && Math.abs(currentSpeed) >= 5) {
            steeringRotation = joystickRotation * rotationSpeed * joystickSensitivity * dt;
        }
        
        if (carHealth < 50) {
            steeringRotation *= (carHealth / 50);
        }
        
        if (steeringRotation !== 0) {
            camera.rotation.y += steeringRotation;
        }
        
        // Cambio autom√°tico de marchas
        if (!isManualTransmission && currentGear >= 0) {
            const config = getCurrentGearConfig();
            if (currentRPM > config.redlineRPM * 0.9 && currentGear < maxGear) {
                currentGear++;
                updateGearIndicator();
            } else if (currentRPM < config.redlineRPM * 0.4 && currentGear > 1) {
                currentGear--;
                updateGearIndicator();
            }
            
            if (currentSpeed > 0) {
                document.getElementById("gearIndicator").textContent = currentGear.toString();
            } else if (currentSpeed < 0) {
                document.getElementById("gearIndicator").textContent = "R";
            } else {
                document.getElementById("gearIndicator").textContent = "N";
            }
        }
        
        // Actualizar sistemas
        recordGhostData();
        updateGhostCar();
        sendPlayerData();
        cleanupInactivePlayers();
        
        // Mover el coche
        if (Math.abs(currentSpeed) > 0.001) { 
            const yaw = camera.rotation.y; 
            const forward = new BABYLON.Vector3(Math.sin(yaw), 0, Math.cos(yaw)); 
            playerMesh.moveWithCollisions(forward.scale(currentSpeed * speedFactor * dt)); 
        }
        
        // Verificar sistemas
        checkCollisions();
        checkFinishLine(); 
        updateTimerDisplay(); 
        keepGround();
        
        // Actualizar UI
        document.getElementById('speedNumber').textContent = Math.abs(currentSpeed).toFixed(0) + ' km/h';
        
        scene.render();
    });

    window.addEventListener('resize', () => engine.resize());

    // Inicializar el coche por defecto
    changeCar('f1');
    </script>
</body>
</html>