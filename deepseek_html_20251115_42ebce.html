<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Carreras Laguna Seca</title>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            touch-action: none;
            background: #000;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial, sans-serif;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }
        .control-btn {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.3);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
        }
        #gameMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            font-family: Arial, sans-serif;
            z-index: 200;
        }
        #startBtn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    
    <div id="ui" style="display: none;">
        <div>Velocidad: <span id="speed">0</span> km/h</div>
        <div>Vueltas: <span id="laps">0</span>/3</div>
        <div>Tiempo: <span id="time">0:00</span></div>
    </div>
    
    <div id="controls" style="display: none;">
        <button class="control-btn" id="left">←</button>
        <button class="control-btn" id="brake">Freno</button>
        <button class="control-btn" id="right">→</button>
    </div>

    <div id="gameMenu">
        <h1>Carreras Laguna Seca</h1>
        <p>Completa 3 vueltas lo más rápido posible</p>
        <p>Controles: Botones izquierda/derecha para girar, Freno para reducir velocidad</p>
        <button id="startBtn">Comenzar Carrera</button>
    </div>

    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script>
        class RacingGame {
            constructor() {
                this.canvas = document.getElementById("renderCanvas");
                this.engine = new BABYLON.Engine(this.canvas, true);
                this.scene = null;
                this.car = null;
                this.camera = null;
                this.speed = 0;
                this.maxSpeed = 80;
                this.acceleration = 0.3;
                this.deceleration = 0.15;
                this.brakePower = 0.4;
                this.steering = 0;
                this.maxSteering = 0.8;
                this.steeringSpeed = 0.15;
                
                // Estado del juego
                this.laps = 0;
                this.maxLaps = 3;
                this.gameTime = 0;
                this.isGameRunning = false;
                this.isGameStarted = false;
                
                // Controles
                this.keys = {
                    left: false,
                    right: false,
                    brake: false
                };
                
                this.init();
            }

            async init() {
                // Crear escena
                this.scene = new BABYLON.Scene(this.engine);
                
                // Configurar cámara
                this.setupCamera();
                
                // Configurar luces
                this.setupLights();
                
                // Cargar pista
                await this.loadTrack();
                
                // Crear coche
                this.createCar();
                
                // Configurar controles
                this.setupControls();
                
                // Configurar física
                this.setupPhysics();
                
                // Iniciar bucle del juego
                this.engine.runRenderLoop(() => {
                    if (this.isGameStarted) {
                        this.update();
                    }
                    this.scene.render();
                });
                
                // Manejar redimensionado
                window.addEventListener("resize", () => {
                    this.engine.resize();
                });
            }

            setupCamera() {
                // Cámara de tercera persona
                this.camera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0, 5, -10), this.scene);
                this.camera.radius = 12;
                this.camera.heightOffset = 4;
                this.camera.rotationOffset = 180;
                this.camera.cameraAcceleration = 0.1;
                this.camera.maxCameraSpeed = 20;
            }

            setupLights() {
                // Luz ambiental
                new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 1, 0), this.scene);
                
                // Luz direccional (sol)
                const light = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(0, -1, 1), this.scene);
                light.position = new BABYLON.Vector3(0, 50, 0);
                light.intensity = 0.9;
                light.shadowEnabled = true;
            }

            async loadTrack() {
                try {
                    // Cargar el modelo GLB de la pista
                    const result = await BABYLON.SceneLoader.ImportMeshAsync("", "laguna_seca.glb", "", this.scene);
                    
                    // Configurar colisiones para todos los meshes
                    result.meshes.forEach(mesh => {
                        mesh.checkCollisions = true;
                        // Si es el suelo, hacerlo más grande para los límites
                        if (mesh.name.toLowerCase().includes('ground') || mesh.name === '') {
                            mesh.scaling = new BABYLON.Vector3(1.2, 1, 1.2);
                        }
                    });
                    
                    console.log("Pista Laguna Seca cargada correctamente");
                } catch (error) {
                    console.error("Error cargando la pista:", error);
                    this.createFallbackTrack();
                }
            }

            createFallbackTrack() {
                // Pista básica como fallback
                const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 200, height: 200}, this.scene);
                ground.checkCollisions = true;
                ground.position.y = -0.1;
                
                // Material para el césped
                const groundMaterial = new BABYLON.StandardMaterial("groundMat", this.scene);
                groundMaterial.diffuseColor = new BABYLON.Color3(0.2, 0.6, 0.2);
                ground.material = groundMaterial;
                
                // Crear pista de carreras
                this.createRaceTrack();
            }

            createRaceTrack() {
                // Material de la pista
                const trackMaterial = new BABYLON.StandardMaterial("trackMat", this.scene);
                trackMaterial.diffuseColor = new BABYLON.Color3(0.3, 0.3, 0.3);
                
                // Crear pista ovalada básica
                const track = BABYLON.MeshBuilder.CreateCylinder("track", {
                    diameterTop: 150,
                    diameterBottom: 150,
                    height: 0.5,
                    tessellation: 64
                }, this.scene);
                
                track.position.y = 0.1;
                track.material = trackMaterial;
                track.checkCollisions = true;
                
                // Agujero central
                const hole = BABYLON.MeshBuilder.CreateCylinder("hole", {
                    diameterTop: 100,
                    diameterBottom: 100,
                    height: 1,
                    tessellation: 64
                }, this.scene);
                
                hole.position.y = 0;
                hole.material = groundMaterial;
                hole.checkCollisions = false;
            }

            createCar() {
                // Crear cuerpo principal del coche
                const carBody = BABYLON.MeshBuilder.CreateBox("carBody", {
                    width: 1.8,
                    height: 0.8,
                    depth: 4
                }, this.scene);
                
                // Crear cabina
                const cabin = BABYLON.MeshBuilder.CreateBox("cabin", {
                    width: 1.6,
                    height: 0.7,
                    depth: 1.8
                }, this.scene);
                cabin.position.y = 0.75;
                cabin.position.z = -0.3;
                
                // Ruedas
                const wheelPositions = [
                    {x: -1, y: -0.4, z: 1.2},   // Delantera izquierda
                    {x: 1, y: -0.4, z: 1.2},    // Delantera derecha
                    {x: -1, y: -0.4, z: -1.2},  // Trasera izquierda
                    {x: 1, y: -0.4, z: -1.2}    // Trasera derecha
                ];
                
                const wheels = [];
                wheelPositions.forEach((pos, index) => {
                    const wheel = BABYLON.MeshBuilder.CreateCylinder(`wheel${index}`, {
                        diameter: 0.8,
                        height: 0.3,
                        tessellation: 16
                    }, this.scene);
                    
                    wheel.position = new BABYLON.Vector3(pos.x, pos.y, pos.z);
                    wheel.rotation.x = Math.PI / 2;
                    wheels.push(wheel);
                });
                
                // Material del coche
                const carMaterial = new BABYLON.StandardMaterial("carMat", this.scene);
                carMaterial.diffuseColor = new BABYLON.Color3(0.9, 0.1, 0.1); // Rojo
                
                const wheelMaterial = new BABYLON.StandardMaterial("wheelMat", this.scene);
                wheelMaterial.diffuseColor = new BABYLON.Color3(0.1, 0.1, 0.1); // Negro
                
                // Aplicar materiales
                carBody.material = carMaterial;
                cabin.material = carMaterial;
                wheels.forEach(wheel => wheel.material = wheelMaterial);
                
                // Crear parent mesh para el coche completo
                this.car = new BABYLON.Mesh("car", this.scene);
                carBody.parent = this.car;
                cabin.parent = this.car;
                wheels.forEach(wheel => wheel.parent = this.car);
                
                // Posicionar coche en la pista
                this.car.position = new BABYLON.Vector3(0, 1, 0);
                this.car.rotation = new BABYLON.Vector3(0, 0, 0);
                
                // Configurar colisiones
                this.car.checkCollisions = true;
                carBody.checkCollisions = true;
                
                // Asignar cámara al coche
                this.camera.lockedTarget = this.car;
            }

            setupControls() {
                // Controles táctiles
                const leftBtn = document.getElementById("left");
                const rightBtn = document.getElementById("right");
                const brakeBtn = document.getElementById("brake");
                
                leftBtn.addEventListener("touchstart", (e) => {
                    e.preventDefault();
                    this.keys.left = true;
                });
                leftBtn.addEventListener("touchend", (e) => {
                    e.preventDefault();
                    this.keys.left = false;
                });
                
                rightBtn.addEventListener("touchstart", (e) => {
                    e.preventDefault();
                    this.keys.right = true;
                });
                rightBtn.addEventListener("touchend", (e) => {
                    e.preventDefault();
                    this.keys.right = false;
                });
                
                brakeBtn.addEventListener("touchstart", (e) => {
                    e.preventDefault();
                    this.keys.brake = true;
                });
                brakeBtn.addEventListener("touchend", (e) => {
                    e.preventDefault();
                    this.keys.brake = false;
                });
                
                // Controles de teclado para desarrollo
                window.addEventListener("keydown", (e) => {
                    switch(e.key) {
                        case "ArrowLeft": this.keys.left = true; break;
                        case "ArrowRight": this.keys.right = true; break;
                        case " ": this.keys.brake = true; break;
                    }
                });
                
                window.addEventListener("keyup", (e) => {
                    switch(e.key) {
                        case "ArrowLeft": this.keys.left = false; break;
                        case "ArrowRight": this.keys.right = false; break;
                        case " ": this.keys.brake = false; break;
                    }
                });
            }

            setupPhysics() {
                // Configurar gravedad
                this.scene.gravity = new BABYLON.Vector3(0, -9.81, 0);
                
                // Habilitar colisiones
                this.scene.collisionsEnabled = true;
                
                // Configurar cámara para colisiones
                this.camera.checkCollisions = true;
                this.camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
            }

            update() {
                if (!this.isGameRunning) return;
                
                const deltaTime = this.engine.getDeltaTime() / 1000;
                this.gameTime += deltaTime;
                
                this.updateCarPhysics(deltaTime);
                this.updateUI();
                this.checkLapCompletion();
            }

            updateCarPhysics(deltaTime) {
                // Aceleración automática
                if (!this.keys.brake && this.speed < this.maxSpeed) {
                    this.speed += this.acceleration;
                }
                
                // Freno
                if (this.keys.brake) {
                    this.speed = Math.max(0, this.speed - this.brakePower);
                }
                
                // Deceleración natural
                if (!this.keys.brake && this.speed > 0) {
                    this.speed = Math.max(0, this.speed - this.deceleration * 0.1);
                }
                
                // Dirección
                if (this.keys.left) {
                    this.steering = Math.min(this.steering + this.steeringSpeed, this.maxSteering);
                } else if (this.keys.right) {
                    this.steering = Math.max(this.steering - this.steeringSpeed, -this.maxSteering);
                } else {
                    // Retorno automático del volante
                    this.steering *= 0.9;
                    if (Math.abs(this.steering) < 0.01) this.steering = 0;
                }
                
                // Aplicar movimiento
                const speedFactor = this.speed * deltaTime;
                const rotationFactor = this.steering * speedFactor * 0.5;
                
                this.car.rotation.y += rotationFactor;
                
                const direction = new BABYLON.Vector3(
                    Math.sin(this.car.rotation.y),
                    0,
                    Math.cos(this.car.rotation.y)
                );
                
                this.car.position.addInPlace(direction.scale(speedFactor));
            }

            updateUI() {
                document.getElementById("speed").textContent = Math.round(this.speed * 10);
                document.getElementById("laps").textContent = this.laps;
                
                const minutes = Math.floor(this.gameTime / 60);
                const seconds = Math.floor(this.gameTime % 60);
                document.getElementById("time").textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            checkLapCompletion() {
                // Lógica básica de detección de vueltas
                // En un juego real, necesitarías puntos de control
                if (this.car.position.z > 90 && this.speed > 10) {
                    this.laps++;
                    if (this.laps >= this.maxLaps) {
                        this.finishGame();
                    }
                }
            }

            startGame() {
                this.isGameStarted = true;
                this.isGameRunning = true;
                document.getElementById("gameMenu").style.display = "none";
                document.getElementById("ui").style.display = "block";
                document.getElementById("controls").style.display = "flex";
                
                // Reiniciar estadísticas
                this.laps = 0;
                this.gameTime = 0;
                this.speed = 0;
                this.steering = 0;
                
                // Posicionar coche al inicio
                this.car.position = new BABYLON.Vector3(0, 1, 0);
                this.car.rotation = new BABYLON.Vector3(0, 0, 0);
            }

            finishGame() {
                this.isGameRunning = false;
                
                const finalTime = document.getElementById("time").textContent;
                
                const menu = document.getElementById("gameMenu");
                menu.innerHTML = `
                    <h1>¡Carrera Completada!</h1>
                    <p>Has completado ${this.maxLaps} vueltas en ${finalTime}</p>
                    <button id="restartBtn">Nueva Carrera</button>
                `;
                menu.style.display = "block";
                
                document.getElementById("restartBtn").addEventListener("click", () => {
                    this.startGame();
                });
            }
        }

        // Inicializar el juego cuando se carga la página
        window.addEventListener("DOMContentLoaded", () => {
            const game = new RacingGame();
            
            document.getElementById("startBtn").addEventListener("click", () => {
                game.startGame();
            });
        });
    </script>
</body>
</html>